<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
<meta name="viewport"
      content="width=device-width, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0">
<meta http-equiv="X-UA-Compatible" content="ie=edge">

    <meta name="author" content="Jamza">





<title>macvlan 网络模式实现跨主机 Docker 通信 | Jamza&#39;s Blog</title>



    <link rel="icon" href="/image/head.jpg">




    <!-- stylesheets list from _config.yml -->
    
    <link rel="stylesheet" href="/css/style.css">
    



    <!-- scripts list from _config.yml -->
    
    <script src="/js/script.js"></script>
    
    <script src="/js/tocbot.min.js"></script>
    



    
    
        
    


<meta name="generator" content="Hexo 5.4.0"></head>
<body>
    <div class="wrapper">
        <header>
    <nav class="navbar">
        <div class="container">
            <div class="navbar-header header-logo"><a href="/">Jamza&#39;s Blog</a></div>
            <div class="menu navbar-right">
                
                    <a class="menu-item" href="/archives">Posts</a>
                
                    <a class="menu-item" href="/category">Categories</a>
                
                    <a class="menu-item" href="/tag">Tags</a>
                
                    <a class="menu-item" href="/about">About</a>
                
                <input id="switch_default" type="checkbox" class="switch_default">
                <label for="switch_default" class="toggleBtn"></label>
            </div>
        </div>
    </nav>

    
    <nav class="navbar-mobile" id="nav-mobile">
        <div class="container">
            <div class="navbar-header">
                <div>
                    <a href="/">Jamza&#39;s Blog</a><a id="mobile-toggle-theme">·&nbsp;Light</a>
                </div>
                <div class="menu-toggle" onclick="mobileBtn()">&#9776; Menu</div>
            </div>
            <div class="menu" id="mobile-menu">
                
                    <a class="menu-item" href="/archives">Posts</a>
                
                    <a class="menu-item" href="/category">Categories</a>
                
                    <a class="menu-item" href="/tag">Tags</a>
                
                    <a class="menu-item" href="/about">About</a>
                
            </div>
        </div>
    </nav>

</header>
<script>
    var mobileBtn = function f() {
        var toggleMenu = document.getElementsByClassName("menu-toggle")[0];
        var mobileMenu = document.getElementById("mobile-menu");
        if(toggleMenu.classList.contains("active")){
           toggleMenu.classList.remove("active")
            mobileMenu.classList.remove("active")
        }else{
            toggleMenu.classList.add("active")
            mobileMenu.classList.add("active")
        }
    }
</script>
        <div class="main">
            <div class="container">
    
    

    
    <article class="post-wrap">
        <header class="post-header">
            <h1 class="post-title">macvlan 网络模式实现跨主机 Docker 通信</h1>
            
                <div class="post-meta">
                    
                        Author: <a itemprop="author" rel="author" href="/">Jamza</a>
                    

                    
                        <span class="post-time">
                        Date: <a href="#">May 22, 2021&nbsp;&nbsp;12:18:06</a>
                        </span>
                    
                    
                        <span class="post-category">
                    Category:
                            
                                <a href="/categories/%E4%BA%91%E8%AE%A1%E7%AE%97/">云计算</a>
                            
                        </span>
                    
                </div>
            
        </header>

        <div class="post-content">
            <h1 id="macvlan-网络模式实现跨主机-Docker-通信"><a href="#macvlan-网络模式实现跨主机-Docker-通信" class="headerlink" title="macvlan 网络模式实现跨主机 Docker 通信"></a>macvlan 网络模式实现跨主机 Docker 通信</h1><h2 id="macvlan-网络模式概念"><a href="#macvlan-网络模式概念" class="headerlink" title="macvlan 网络模式概念"></a>macvlan 网络模式概念</h2><p>macvlan 本身是 linux 内核的模块，本质上是一种网卡虚拟化的技术，其功能是允许在同一个物理网卡上虚拟出多个网卡，通过不同的 MAC 地址在数据链路层进行网络数据的转发。</p>
<p>一块网卡上配置多个 MAC 地址，即多个接口，每个接口都可以配置自身的 IP 地址。Docker 的 macvlan 网络实际上就是使用了 Linux 提供的 macvlan 驱动功能。</p>
<p>因为多个 MAC 地址的网络数据包都是从同一个网卡上传输，因此需要打开网卡的混杂模式，即 ip link set eth0 promisc on</p>
<p>在 Docker 下创建 macvlan 网络不同于创建 bridge 网络模式，需要指定网段与网关，且网段与网关需是物理上存在的。</p>
<p>macvlan 网络模式不依赖于网桥，所以使用 brctl show 将看到并没有创建新的网桥。但是查看容器内的网络，将会看到每个虚拟网卡都对应一个容器外部的接口。</p>
<figure class="highlight elixir"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">/ <span class="comment"># ip addr</span></span><br><span class="line"><span class="number">1</span>: <span class="symbol">lo:</span> &lt;LOOPBACK,UP,LOWER_UP&gt; mtu <span class="number">65536</span> qdisc noqueue qlen <span class="number">1</span></span><br><span class="line">    link/loopback 00<span class="symbol">:</span>00<span class="symbol">:</span>00<span class="symbol">:</span>00<span class="symbol">:</span>00<span class="symbol">:</span>00 brd 00<span class="symbol">:</span>00<span class="symbol">:</span>00<span class="symbol">:</span>00<span class="symbol">:</span>00<span class="symbol">:</span>00</span><br><span class="line">    inet <span class="number">127.0</span>.0.<span class="number">1</span>/<span class="number">8</span> scope host lo</span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">    inet6 ::<span class="number">1</span>/<span class="number">128</span> scope host</span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line"><span class="number">627</span>: eth2<span class="variable">@if3</span>: &lt;BROADCAST,MULTICAST,UP,LOWER_UP,M-DOWN&gt; mtu <span class="number">1500</span> qdisc noqueue</span><br><span class="line">    link/ether 02<span class="symbol">:</span><span class="number">42</span><span class="symbol">:c0</span><span class="symbol">:a8</span><span class="symbol">:</span><span class="number">54</span><span class="symbol">:e1</span> brd <span class="symbol">ff:</span><span class="symbol">ff:</span><span class="symbol">ff:</span><span class="symbol">ff:</span><span class="symbol">ff:</span>ff</span><br><span class="line">    inet <span class="number">192.168</span>.<span class="number">84.225</span>/<span class="number">24</span> scope global eth2</span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">    inet6 fe80::<span class="number">42</span><span class="symbol">:c0ff</span><span class="symbol">:fea8</span><span class="symbol">:</span><span class="number">54</span>e1/<span class="number">64</span> scope link</span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line"><span class="number">628</span>: eth1<span class="variable">@if4</span>: &lt;BROADCAST,MULTICAST,UP,LOWER_UP,M-DOWN&gt; mtu <span class="number">1500</span> qdisc noqueue</span><br><span class="line">    link/ether 02<span class="symbol">:</span><span class="number">42</span><span class="symbol">:c0</span><span class="symbol">:a8</span><span class="symbol">:</span><span class="number">55</span><span class="symbol">:e1</span> brd <span class="symbol">ff:</span><span class="symbol">ff:</span><span class="symbol">ff:</span><span class="symbol">ff:</span><span class="symbol">ff:</span>ff</span><br><span class="line">    inet <span class="number">192.168</span>.<span class="number">85.225</span>/<span class="number">24</span> scope global eth1</span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">    inet6 fe80::<span class="number">42</span><span class="symbol">:c0ff</span><span class="symbol">:fea8</span><span class="symbol">:</span><span class="number">55</span>e1/<span class="number">64</span> scope link</span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line"><span class="number">629</span>: eth0<span class="variable">@if2</span>: &lt;BROADCAST,MULTICAST,UP,LOWER_UP,M-DOWN&gt; mtu <span class="number">1500</span> qdisc noqueue</span><br><span class="line">    link/ether 02<span class="symbol">:</span><span class="number">42</span><span class="symbol">:c0</span><span class="symbol">:a8</span><span class="symbol">:</span><span class="number">53</span><span class="symbol">:e1</span> brd <span class="symbol">ff:</span><span class="symbol">ff:</span><span class="symbol">ff:</span><span class="symbol">ff:</span><span class="symbol">ff:</span>ff</span><br><span class="line">    inet <span class="number">192.168</span>.<span class="number">83.225</span>/<span class="number">24</span> scope global eth0</span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">    inet6 fe80::<span class="number">42</span><span class="symbol">:c0ff</span><span class="symbol">:fea8</span><span class="symbol">:</span><span class="number">53</span>e1/<span class="number">64</span> scope link</span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">/ <span class="comment">#</span></span><br></pre></td></tr></table></figure>

<p>比如，以上是在容器内执行 ip addr 指令后显示的各个虚拟网口内容。比如虚拟网口显示“629: eth0@if2”，其中 if2 表示物理网卡的编号为 2 的网口，即如下所示，编号为 2 的网口即 eth0 网口。</p>
<figure class="highlight pf"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">[root@jamza_vm_lp0_litepaas master]<span class="comment"># ip addr</span></span><br><span class="line"><span class="number">1</span>: lo: <span class="variable">&lt;LOOPBACK,UP,LOWER_UP&gt;</span> mtu <span class="number">65536</span> qdisc noqueue <span class="keyword">state</span> UNKNOWN qlen <span class="number">1</span></span><br><span class="line">    link/loopback <span class="number">00</span>:<span class="number">00</span>:<span class="number">00</span>:<span class="number">00</span>:<span class="number">00</span>:<span class="number">00</span> brd <span class="number">00</span>:<span class="number">00</span>:<span class="number">00</span>:<span class="number">00</span>:<span class="number">00</span>:<span class="number">00</span></span><br><span class="line">    <span class="keyword">inet</span> <span class="number">127.0</span>.<span class="number">0.1</span>/<span class="number">8</span> scope host lo</span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">    <span class="keyword">inet6</span> ::<span class="number">1</span>/<span class="number">128</span> scope host</span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line"><span class="number">2</span>: eth0: <span class="variable">&lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt;</span> mtu <span class="number">1500</span> qdisc pfifo_fast <span class="keyword">state</span> UP qlen <span class="number">1000</span></span><br><span class="line">    link/ether <span class="number">52</span>:<span class="number">54</span>:<span class="number">83</span>:cc:dd:<span class="number">00</span> brd ff:ff:ff:ff:ff:ff</span><br><span class="line">    <span class="keyword">inet</span> <span class="number">192.168</span>.<span class="number">83.85</span>/<span class="number">24</span> brd <span class="number">192.168</span>.<span class="number">83.255</span> scope <span class="keyword">global</span> eth0</span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">    <span class="keyword">inet6</span> fe80::<span class="number">5054</span>:<span class="number">83</span>ff:fecc:dd00/<span class="number">64</span> scope link</span><br><span class="line">       valid_lft forever preferred_lft forever</span><br></pre></td></tr></table></figure>

<h2 id="网段规划"><a href="#网段规划" class="headerlink" title="网段规划"></a>网段规划</h2><p>查看宿主机的网口信息：</p>
<figure class="highlight tap"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line">[root@jamza_vm_master_litepaas master]<span class="comment"># ifconfig</span></span><br><span class="line">docker0: flags=4099&lt;UP,BROADCAST,MULTICAST&gt;  mtu 1500</span><br><span class="line">        inet 172.17.6.252  netmask 255.255.255.0  broadcast 0.0.0.0</span><br><span class="line">        inet6 fe80::42:c6ff:fe05:2363  prefixlen<span class="number"> 64 </span> scopeid 0x20&lt;link&gt;</span><br><span class="line">        ether 02:42:c6:05:23:63  txqueuelen<span class="number"> 0 </span> (Ethernet)</span><br><span class="line">        RX packets<span class="number"> 570 </span> bytes<span class="number"> 35680 </span>(34.8 KiB)</span><br><span class="line">        RX errors<span class="number"> 0 </span> dropped<span class="number"> 0 </span> overruns<span class="number"> 0 </span> frame 0</span><br><span class="line">        TX packets<span class="number"> 223 </span> bytes<span class="number"> 19338 </span>(18.8 KiB)</span><br><span class="line">        TX errors<span class="number"> 0 </span> dropped<span class="number"> 0 </span>overruns<span class="number"> 0 </span> carrier<span class="number"> 0 </span> collisions 0</span><br><span class="line"></span><br><span class="line">docker_gwbridge: flags=4099&lt;UP,BROADCAST,MULTICAST&gt;  mtu 1500</span><br><span class="line">        inet 172.18.0.1  netmask 255.255.240.0  broadcast 0.0.0.0</span><br><span class="line">        inet6 fe80::42:42ff:fe41:eebc  prefixlen<span class="number"> 64 </span> scopeid 0x20&lt;link&gt;</span><br><span class="line">        ether 02:42:42:41:ee:bc  txqueuelen<span class="number"> 0 </span> (Ethernet)</span><br><span class="line">        RX packets<span class="number"> 3574777 </span> bytes<span class="number"> 185891316 </span>(177.2 MiB)</span><br><span class="line">        RX errors<span class="number"> 0 </span> dropped<span class="number"> 15 </span> overruns<span class="number"> 0 </span> frame 0</span><br><span class="line">        TX packets<span class="number"> 1530 </span> bytes<span class="number"> 99712 </span>(97.3 KiB)</span><br><span class="line">        TX errors<span class="number"> 0 </span> dropped<span class="number"> 0 </span>overruns<span class="number"> 0 </span> carrier<span class="number"> 0 </span> collisions 0</span><br><span class="line"></span><br><span class="line">eth0: flags=4163&lt;UP,BROADCAST,RUNNING,MULTICAST&gt;  mtu 1500</span><br><span class="line">        inet 192.168.83.83  netmask 255.255.255.0  broadcast 192.168.83.255</span><br><span class="line">        inet6 fe80::5054:83ff:feaa:bb00  prefixlen<span class="number"> 64 </span> scopeid 0x20&lt;link&gt;</span><br><span class="line">        ether 52:54:83:aa:bb:00  txqueuelen<span class="number"> 1000 </span> (Ethernet)</span><br><span class="line">        RX packets<span class="number"> 83683524 </span> bytes<span class="number"> 364816891747 </span>(339.7 GiB)</span><br><span class="line">        RX errors<span class="number"> 0 </span> dropped<span class="number"> 15 </span> overruns<span class="number"> 0 </span> frame 0</span><br><span class="line">        TX packets<span class="number"> 94961933 </span> bytes<span class="number"> 213362123667 </span>(198.7 GiB)</span><br><span class="line">        TX errors<span class="number"> 0 </span> dropped<span class="number"> 0 </span>overruns<span class="number"> 0 </span> carrier<span class="number"> 0 </span> collisions 0</span><br><span class="line"></span><br><span class="line">eth20: flags=4163&lt;UP,BROADCAST,RUNNING,MULTICAST&gt;  mtu 1500</span><br><span class="line">        inet 192.168.84.83  netmask 255.255.255.0  broadcast 192.168.84.255</span><br><span class="line">        inet6 fe80::5054:83ff:feaa:bb20  prefixlen<span class="number"> 64 </span> scopeid 0x20&lt;link&gt;</span><br><span class="line">        ether 52:54:83:aa:bb:20  txqueuelen<span class="number"> 1000 </span> (Ethernet)</span><br><span class="line">        RX packets<span class="number"> 10698672 </span> bytes<span class="number"> 712975406 </span>(679.9 MiB)</span><br><span class="line">        RX errors<span class="number"> 0 </span> dropped<span class="number"> 7120862 </span> overruns<span class="number"> 0 </span> frame 0</span><br><span class="line">        TX packets<span class="number"> 1773 </span> bytes<span class="number"> 122490 </span>(119.6 KiB)</span><br><span class="line">        TX errors<span class="number"> 0 </span> dropped<span class="number"> 0 </span>overruns<span class="number"> 0 </span> carrier<span class="number"> 0 </span> collisions 0</span><br><span class="line"></span><br><span class="line">eth21: flags=4163&lt;UP,BROADCAST,RUNNING,MULTICAST&gt;  mtu 1500</span><br><span class="line">        inet 192.168.85.83  netmask 255.255.255.0  broadcast 192.168.85.255</span><br><span class="line">        inet6 fe80::5054:83ff:feaa:bb21  prefixlen<span class="number"> 64 </span> scopeid 0x20&lt;link&gt;</span><br><span class="line">        ether 52:54:83:aa:bb:21  txqueuelen<span class="number"> 1000 </span> (Ethernet)</span><br><span class="line">        RX packets<span class="number"> 3574777 </span> bytes<span class="number"> 185891316 </span>(177.2 MiB)</span><br><span class="line">        RX errors<span class="number"> 0 </span> dropped<span class="number"> 15 </span> overruns<span class="number"> 0 </span> frame 0</span><br><span class="line">        TX packets<span class="number"> 1530 </span> bytes<span class="number"> 99712 </span>(97.3 KiB)</span><br><span class="line">        TX errors<span class="number"> 0 </span> dropped<span class="number"> 0 </span>overruns<span class="number"> 0 </span> carrier<span class="number"> 0 </span> collisions 0</span><br><span class="line"></span><br><span class="line">lo: flags=73&lt;UP,LOOPBACK,RUNNING&gt;  mtu 65536</span><br><span class="line">        inet 127.0.0.1  netmask 255.0.0.0</span><br><span class="line">        inet6 ::1  prefixlen<span class="number"> 128 </span> scopeid 0x10&lt;host&gt;</span><br><span class="line">        loop  txqueuelen<span class="number"> 1 </span> (Local Loopback)</span><br><span class="line">        RX packets<span class="number"> 34518600 </span> bytes<span class="number"> 4376071963 </span>(4.0 GiB)</span><br><span class="line">        RX errors<span class="number"> 0 </span> dropped<span class="number"> 0 </span> overruns<span class="number"> 0 </span> frame 0</span><br><span class="line">        TX packets<span class="number"> 34518600 </span> bytes<span class="number"> 4376071963 </span>(4.0 GiB)</span><br><span class="line">        TX errors<span class="number"> 0 </span> dropped<span class="number"> 0 </span>overruns<span class="number"> 0 </span> carrier<span class="number"> 0 </span> collisions 0</span><br></pre></td></tr></table></figure>

<p>宿主机包含三个物理网卡，分别是 eth0、eth20 与 eth21，因此规划建立 3 个 macvlan 模式网络，考虑主控与线卡的 macvlan 模式网络为同一网段，为防止主控与线卡上的网段重合，通过 ip-range 选项设定主控与线卡的 ip 地址池，具体规划如下：</p>
<h3 id="网络-1-规划"><a href="#网络-1-规划" class="headerlink" title="网络 1 规划"></a>网络 1 规划</h3><p>net_name：rcm_net1</p>
<p>subnet：192.168.83.0/24</p>
<p>gateway：192.168.83.1</p>
<p>parent_interface：eth0</p>
<p>ip_range：192.168.83.240/28（master） 192.168.83.224/28（lp）</p>
<h3 id="网络-2-规划"><a href="#网络-2-规划" class="headerlink" title="网络 2 规划"></a>网络 2 规划</h3><p>net_name：rcm_net2</p>
<p>subnet：192.168.84.0/24</p>
<p>gateway：192.168.84.1</p>
<p>parent_interface：eth20</p>
<p>ip_range：192.168.84.240/28（master） 192.168.84.224/28（lp）</p>
<h3 id="网络-3-规划"><a href="#网络-3-规划" class="headerlink" title="网络 3 规划"></a>网络 3 规划</h3><p>net_name：rcm_net3</p>
<p>subnet：192.168.85.0/24</p>
<p>gateway：192.168.85.1</p>
<p>parent_interface：eth21</p>
<p>ip_range：192.168.85.240/28（master） 192.168.85.224/28（lp）</p>
<h2 id="网络建立"><a href="#网络建立" class="headerlink" title="网络建立"></a>网络建立</h2><p>网络建立之前，主控系统的 docker 网络列表如下：</p>
<figure class="highlight autoit"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">[root<span class="symbol">@jamza_vm_master_litepaas</span> master]<span class="meta"># docker network ls</span></span><br><span class="line">NETWORK ID          NAME                DRIVER              SCOPE</span><br><span class="line">a78327e048e0        bridge              bridge              <span class="keyword">local</span></span><br><span class="line">b919f69968ec        docker_gwbridge     bridge              <span class="keyword">local</span></span><br><span class="line"><span class="number">032</span>c767b11de        host                host                <span class="keyword">local</span></span><br><span class="line">cad8d79e6d05        none                <span class="literal">null</span>                <span class="keyword">local</span></span><br><span class="line">[root<span class="symbol">@jamza_vm_master_litepaas</span> master]<span class="meta">#</span></span><br></pre></td></tr></table></figure>

<p>通过 docker network create 命令，建立 macvlan 网络模式，如下：</p>
<figure class="highlight autoit"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line">[root<span class="symbol">@jamza_vm_master_litepaas</span> master]<span class="meta"># docker network create -d macvlan --subnet=192.168.83.0/24 --gateway=192.168.83.1 --ip-range=192.168.83.240/28 -o parent=eth0 rcm_net1</span></span><br><span class="line">a3db1d77c949c20638d04fc0049e6522e318ff0dc6f647b609ab3196ee9ef50b</span><br><span class="line">[root<span class="symbol">@jamza_vm_master_litepaas</span> master]<span class="meta">#</span></span><br><span class="line">[root<span class="symbol">@jamza_vm_master_litepaas</span> master]<span class="meta"># docker network ls</span></span><br><span class="line">NETWORK ID          NAME                DRIVER              SCOPE</span><br><span class="line">a78327e048e0        bridge              bridge              <span class="keyword">local</span></span><br><span class="line">b919f69968ec        docker_gwbridge     bridge              <span class="keyword">local</span></span><br><span class="line"><span class="number">032</span>c767b11de        host                host                <span class="keyword">local</span></span><br><span class="line">cad8d79e6d05        none                <span class="literal">null</span>                <span class="keyword">local</span></span><br><span class="line">a3db1d77c949        rcm_net1            macvlan             <span class="keyword">local</span></span><br><span class="line">[root<span class="symbol">@jamza_vm_master_litepaas</span> master]<span class="meta">#</span></span><br><span class="line">[root<span class="symbol">@jamza_vm_master_litepaas</span> master]<span class="meta"># docker network inspect rcm_net1</span></span><br><span class="line">[</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="string">&quot;Name&quot;</span>: <span class="string">&quot;rcm_net1&quot;</span>,</span><br><span class="line">        <span class="string">&quot;Id&quot;</span>: <span class="string">&quot;a3db1d77c949c20638d04fc0049e6522e318ff0dc6f647b609ab3196ee9ef50b&quot;</span>,</span><br><span class="line">        <span class="string">&quot;Created&quot;</span>: <span class="string">&quot;2019-07-31T13:38:59.184319993+08:00&quot;</span>,</span><br><span class="line">        <span class="string">&quot;Scope&quot;</span>: <span class="string">&quot;local&quot;</span>,</span><br><span class="line">        <span class="string">&quot;Driver&quot;</span>: <span class="string">&quot;macvlan&quot;</span>,</span><br><span class="line">        <span class="string">&quot;EnableIPv6&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">        <span class="string">&quot;IPAM&quot;</span>: &#123;</span><br><span class="line">            <span class="string">&quot;Driver&quot;</span>: <span class="string">&quot;default&quot;</span>,</span><br><span class="line">            <span class="string">&quot;Options&quot;</span>: &#123;&#125;,</span><br><span class="line">            <span class="string">&quot;Config&quot;</span>: [</span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="string">&quot;Subnet&quot;</span>: <span class="string">&quot;192.168.83.0/24&quot;</span>,</span><br><span class="line">                    <span class="string">&quot;IPRange&quot;</span>: <span class="string">&quot;192.168.83.240/28&quot;</span>,</span><br><span class="line">                    <span class="string">&quot;Gateway&quot;</span>: <span class="string">&quot;192.168.83.1&quot;</span></span><br><span class="line">                &#125;</span><br><span class="line">            ]</span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="string">&quot;Internal&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">        <span class="string">&quot;Attachable&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">        <span class="string">&quot;Containers&quot;</span>: &#123;&#125;,</span><br><span class="line">        <span class="string">&quot;Options&quot;</span>: &#123;</span><br><span class="line">            <span class="string">&quot;parent&quot;</span>: <span class="string">&quot;eth0&quot;</span></span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="string">&quot;Labels&quot;</span>: &#123;&#125;</span><br><span class="line">    &#125;</span><br><span class="line">]</span><br><span class="line">[root<span class="symbol">@jamza_vm_master_litepaas</span> master]<span class="meta">#</span></span><br></pre></td></tr></table></figure>

<p>同理，创建另外两个 macvlan 网络：</p>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">[root@jamza_vm_master_litepaas master]# docker<span class="built_in"> network </span>create -d macvlan <span class="attribute">--subnet</span>=192.168.84.0/24 <span class="attribute">--gateway</span>=192.168.84.1 <span class="attribute">--ip-range</span>=192.168.84.240/28 -o <span class="attribute">parent</span>=eth20 rcm_net2</span><br><span class="line">b95e405b383d0b3c6035c9f7ea556f315def34d9d4cf290f7ca2ba6272341d20</span><br><span class="line">[root@jamza_vm_master_litepaas master]#</span><br><span class="line">[root@jamza_vm_master_litepaas master]# docker<span class="built_in"> network </span>create -d macvlan <span class="attribute">--subnet</span>=192.168.85.0/24 <span class="attribute">--gateway</span>=192.168.85.1 <span class="attribute">--ip-range</span>=192.168.85.240/28 -o <span class="attribute">parent</span>=eth21 rcm_net3</span><br><span class="line">2fe74eed7b69033582cfa44ba4d16f06feee0b1f56234d0640948da81f9674bc</span><br><span class="line">[root@jamza_vm_master_litepaas master]#</span><br><span class="line">[root@jamza_vm_master_litepaas master]# docker<span class="built_in"> network </span>ls<span class="built_in"></span></span><br><span class="line"><span class="built_in">NETWORK </span>ID          NAME                DRIVER              SCOPE</span><br><span class="line">a78327e048e0       <span class="built_in"> bridge </span>            <span class="built_in"> bridge </span>             local</span><br><span class="line">b919f69968ec        docker_gwbridge    <span class="built_in"> bridge </span>             local</span><br><span class="line">032c767b11de        host                host                local</span><br><span class="line">cad8d79e6d05        none                <span class="literal">null</span>                local</span><br><span class="line">a3db1d77c949        rcm_net1            macvlan             local</span><br><span class="line">b95e405b383d        rcm_net2            macvlan             local</span><br><span class="line">2fe74eed7b69        rcm_net3            macvlan             local</span><br><span class="line">[root@jamza_vm_master_litepaas master]#</span><br></pre></td></tr></table></figure>

<p>在线卡主机上也创建同样的三个网络，区别是 ip 地址池不同：</p>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line">[root@jamza_vm_lp0_litepaas master]# docker<span class="built_in"> network </span>ls<span class="built_in"></span></span><br><span class="line"><span class="built_in">NETWORK </span>ID          NAME                DRIVER              SCOPE</span><br><span class="line">eae88252b139       <span class="built_in"> bridge </span>            <span class="built_in"> bridge </span>             local</span><br><span class="line">bd5b745fb87f        docker_gwbridge    <span class="built_in"> bridge </span>             local</span><br><span class="line">a20b3d67c74d        host                host                local</span><br><span class="line">d8bdffcb4f6e        none                <span class="literal">null</span>                local</span><br><span class="line">[root@jamza_vm_lp0_litepaas master]#</span><br><span class="line">[root@jamza_vm_lp0_litepaas master]# docker<span class="built_in"> network </span>create -d macvlan <span class="attribute">--subnet</span>=192.168.83.0/24 <span class="attribute">--gateway</span>=192.168.83.1 <span class="attribute">--ip-range</span>=192.168.83.224/28 -o <span class="attribute">parent</span>=eth0 rcm_net1</span><br><span class="line">afc8a5c72b2a87b89837cc096b8b4d6fcf312b83ef578bf05bc6be8fce4c0b7c</span><br><span class="line">[root@jamza_vm_lp0_litepaas master]#</span><br><span class="line">[root@jamza_vm_lp0_litepaas master]# docker<span class="built_in"> network </span>create -d macvlan <span class="attribute">--subnet</span>=192.168.84.0/24 <span class="attribute">--gateway</span>=192.168.84.1 <span class="attribute">--ip-range</span>=192.168.84.224/28 -o <span class="attribute">parent</span>=eth20 rcm_net2</span><br><span class="line">9a6fda4d7da07317dad8edb3fdb2595a986631a5e2211ecf02f422bddc6de12b</span><br><span class="line">[root@jamza_vm_lp0_litepaas master]#</span><br><span class="line">[root@jamza_vm_lp0_litepaas master]# docker<span class="built_in"> network </span>create -d macvlan <span class="attribute">--subnet</span>=192.168.85.0/24 <span class="attribute">--gateway</span>=192.168.85.1 <span class="attribute">--ip-range</span>=192.168.85.224/28 -o <span class="attribute">parent</span>=eth21 rcm_net3</span><br><span class="line">13f9679e4f1a521ed1506bb41b65340f9775e6bde0669192874b0c58f6822b33</span><br><span class="line">[root@jamza_vm_lp0_litepaas master]#</span><br><span class="line">[root@jamza_vm_lp0_litepaas master]# docker<span class="built_in"> network </span>ls<span class="built_in"></span></span><br><span class="line"><span class="built_in">NETWORK </span>ID          NAME                DRIVER              SCOPE</span><br><span class="line">eae88252b139       <span class="built_in"> bridge </span>            <span class="built_in"> bridge </span>             local</span><br><span class="line">bd5b745fb87f        docker_gwbridge    <span class="built_in"> bridge </span>             local</span><br><span class="line">a20b3d67c74d        host                host                local</span><br><span class="line">d8bdffcb4f6e        none                <span class="literal">null</span>                local</span><br><span class="line">afc8a5c72b2a        rcm_net1            macvlan             local</span><br><span class="line">9a6fda4d7da0        rcm_net2            macvlan             local</span><br><span class="line">13f9679e4f1a        rcm_net3            macvlan             local</span><br><span class="line">[root@jamza_vm_lp0_litepaas master]#</span><br><span class="line">[root@jamza_vm_lp0_litepaas master]# docker<span class="built_in"> network </span>inspect rcm_net1</span><br><span class="line">[</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="string">&quot;Name&quot;</span>: <span class="string">&quot;rcm_net1&quot;</span>,</span><br><span class="line">        <span class="string">&quot;Id&quot;</span>: <span class="string">&quot;afc8a5c72b2a87b89837cc096b8b4d6fcf312b83ef578bf05bc6be8fce4c0b7c&quot;</span>,</span><br><span class="line">        <span class="string">&quot;Created&quot;</span>: <span class="string">&quot;2019-07-31T13:46:03.832634708+08:00&quot;</span>,</span><br><span class="line">        <span class="string">&quot;Scope&quot;</span>: <span class="string">&quot;local&quot;</span>,</span><br><span class="line">        <span class="string">&quot;Driver&quot;</span>: <span class="string">&quot;macvlan&quot;</span>,</span><br><span class="line">        <span class="string">&quot;EnableIPv6&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">        <span class="string">&quot;IPAM&quot;</span>: &#123;</span><br><span class="line">            <span class="string">&quot;Driver&quot;</span>: <span class="string">&quot;default&quot;</span>,</span><br><span class="line">            <span class="string">&quot;Options&quot;</span>: &#123;&#125;,</span><br><span class="line">            <span class="string">&quot;Config&quot;</span>: [</span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="string">&quot;Subnet&quot;</span>: <span class="string">&quot;192.168.83.0/24&quot;</span>,</span><br><span class="line">                    <span class="string">&quot;IPRange&quot;</span>: <span class="string">&quot;192.168.83.224/28&quot;</span>,</span><br><span class="line">                    <span class="string">&quot;Gateway&quot;</span>: <span class="string">&quot;192.168.83.1&quot;</span></span><br><span class="line">                &#125;</span><br><span class="line">            ]</span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="string">&quot;Internal&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">        <span class="string">&quot;Attachable&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">        <span class="string">&quot;Containers&quot;</span>: &#123;&#125;,</span><br><span class="line">        <span class="string">&quot;Options&quot;</span>: &#123;</span><br><span class="line">            <span class="string">&quot;parent&quot;</span>: <span class="string">&quot;eth0&quot;</span></span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="string">&quot;Labels&quot;</span>: &#123;&#125;</span><br><span class="line">    &#125;</span><br><span class="line">]</span><br><span class="line">[root@jamza_vm_lp0_litepaas master]#</span><br></pre></td></tr></table></figure>

<h2 id="创建连接至-macvlan-的-Docker-容器"><a href="#创建连接至-macvlan-的-Docker-容器" class="headerlink" title="创建连接至 macvlan 的 Docker 容器"></a>创建连接至 macvlan 的 Docker 容器</h2><p>在主控环境创建连接至三个 macvlan 网络的 Docker 容器，容器中已经创建了三个网卡，分别对应连接的三个 macvlan 网络，其 ip 地址也是对应的网段的 ip 地址池范围内的：</p>
<figure class="highlight vim"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line">[root@jamza_vm_master_litepaas master]# docker <span class="keyword">ps</span> -<span class="keyword">a</span></span><br><span class="line">CONTAINER ID        IMAGE               COMMAND             CREATED             STATUS              PORTS               NAMES</span><br><span class="line">[root@jamza_vm_master_litepaas master]#</span><br><span class="line">[root@jamza_vm_master_litepaas master]# docker create -it --privileged=true --net rcm_net1 --name test busybox/x86_64:latest /bin/<span class="keyword">sh</span></span><br><span class="line"><span class="number">4</span>c4a70764b65f043a5ab6d37d5a49a38eab4fcaa3d2fb46adffcd0afe8f55559</span><br><span class="line">[root@jamza_vm_master_litepaas master]#</span><br><span class="line">[root@jamza_vm_master_litepaas master]# docker network connect rcm_net2 test</span><br><span class="line">[root@jamza_vm_master_litepaas master]#</span><br><span class="line">[root@jamza_vm_master_litepaas master]# docker network connect rcm_net3 test</span><br><span class="line">[root@jamza_vm_master_litepaas master]#</span><br><span class="line">[root@jamza_vm_master_litepaas master]# docker start -i test</span><br><span class="line">/ #</span><br><span class="line">/ # ifconfig</span><br><span class="line">eth0      Link encap:Ethernet  HWaddr <span class="number">02</span>:<span class="number">42</span>:C0:A8:<span class="number">53</span>:F0</span><br><span class="line">          inet addr:<span class="number">192.168</span>.<span class="number">83.240</span>  Bcas<span class="variable">t:0</span>.<span class="number">0.0</span>.<span class="number">0</span>  Mask:<span class="number">255.255</span>.<span class="number">255.0</span></span><br><span class="line">          inet6 addr: fe80::<span class="number">42</span>:c0ff:fea8:<span class="number">53</span>f0/<span class="number">64</span> Scope:Link</span><br><span class="line">          UP BROADCAST RUNNING MULTICAST  MTU:<span class="number">1500</span>  Metric:<span class="number">1</span></span><br><span class="line">          RX packet<span class="variable">s:0</span> error<span class="variable">s:0</span> dropped:<span class="number">0</span> overrun<span class="variable">s:0</span> frame:<span class="number">0</span></span><br><span class="line">          TX packet<span class="variable">s:7</span> error<span class="variable">s:0</span> dropped:<span class="number">0</span> overrun<span class="variable">s:0</span> carrier:<span class="number">0</span></span><br><span class="line">          collision<span class="variable">s:0</span> txqueuelen:<span class="number">0</span></span><br><span class="line">          RX byte<span class="variable">s:0</span> (<span class="number">0.0</span> B)  TX byte<span class="variable">s:578</span> (<span class="number">578.0</span> B)</span><br><span class="line"></span><br><span class="line">eth1      Link encap:Ethernet  HWaddr <span class="number">02</span>:<span class="number">42</span>:C0:A8:<span class="number">54</span>:F0</span><br><span class="line">          inet addr:<span class="number">192.168</span>.<span class="number">84.240</span>  Bcas<span class="variable">t:0</span>.<span class="number">0.0</span>.<span class="number">0</span>  Mask:<span class="number">255.255</span>.<span class="number">255.0</span></span><br><span class="line">          inet6 addr: fe80::<span class="number">42</span>:c0ff:fea8:<span class="number">54</span>f0/<span class="number">64</span> Scope:Link</span><br><span class="line">          UP BROADCAST RUNNING MULTICAST  MTU:<span class="number">1500</span>  Metric:<span class="number">1</span></span><br><span class="line">          RX packet<span class="variable">s:0</span> error<span class="variable">s:0</span> dropped:<span class="number">0</span> overrun<span class="variable">s:0</span> frame:<span class="number">0</span></span><br><span class="line">          TX packet<span class="variable">s:7</span> error<span class="variable">s:0</span> dropped:<span class="number">0</span> overrun<span class="variable">s:0</span> carrier:<span class="number">0</span></span><br><span class="line">          collision<span class="variable">s:0</span> txqueuelen:<span class="number">0</span></span><br><span class="line">          RX byte<span class="variable">s:0</span> (<span class="number">0.0</span> B)  TX byte<span class="variable">s:578</span> (<span class="number">578.0</span> B)</span><br><span class="line"></span><br><span class="line">eth2      Link encap:Ethernet  HWaddr <span class="number">02</span>:<span class="number">42</span>:C0:A8:<span class="number">55</span>:F0</span><br><span class="line">          inet addr:<span class="number">192.168</span>.<span class="number">85.240</span>  Bcas<span class="variable">t:0</span>.<span class="number">0.0</span>.<span class="number">0</span>  Mask:<span class="number">255.255</span>.<span class="number">255.0</span></span><br><span class="line">          inet6 addr: fe80::<span class="number">42</span>:c0ff:fea8:<span class="number">55</span>f0/<span class="number">64</span> Scope:Link</span><br><span class="line">          UP BROADCAST RUNNING MULTICAST  MTU:<span class="number">1500</span>  Metric:<span class="number">1</span></span><br><span class="line">          RX packet<span class="variable">s:0</span> error<span class="variable">s:0</span> dropped:<span class="number">0</span> overrun<span class="variable">s:0</span> frame:<span class="number">0</span></span><br><span class="line">          TX packet<span class="variable">s:7</span> error<span class="variable">s:0</span> dropped:<span class="number">0</span> overrun<span class="variable">s:0</span> carrier:<span class="number">0</span></span><br><span class="line">          collision<span class="variable">s:0</span> txqueuelen:<span class="number">0</span></span><br><span class="line">          RX byte<span class="variable">s:0</span> (<span class="number">0.0</span> B)  TX byte<span class="variable">s:578</span> (<span class="number">578.0</span> B)</span><br><span class="line"></span><br><span class="line"><span class="keyword">lo</span>        Link encap:Local Loopback</span><br><span class="line">          inet addr:<span class="number">127.0</span>.<span class="number">0.1</span>  Mask:<span class="number">255.0</span>.<span class="number">0.0</span></span><br><span class="line">          inet6 addr: ::<span class="number">1</span>/<span class="number">128</span> Scope:Host</span><br><span class="line">          UP LOOPBACK RUNNING  MTU:<span class="number">65536</span>  Metric:<span class="number">1</span></span><br><span class="line">          RX packet<span class="variable">s:0</span> error<span class="variable">s:0</span> dropped:<span class="number">0</span> overrun<span class="variable">s:0</span> frame:<span class="number">0</span></span><br><span class="line">          TX packet<span class="variable">s:0</span> error<span class="variable">s:0</span> dropped:<span class="number">0</span> overrun<span class="variable">s:0</span> carrier:<span class="number">0</span></span><br><span class="line">          collision<span class="variable">s:0</span> txqueuelen:<span class="number">1</span></span><br><span class="line">          RX byte<span class="variable">s:0</span> (<span class="number">0.0</span> B)  TX byte<span class="variable">s:0</span> (<span class="number">0.0</span> B)</span><br><span class="line"></span><br><span class="line">/ #</span><br></pre></td></tr></table></figure>

<p>同理，在线卡主机环境中，创建连接至三个 macvlan 网络的 Docker 容器：</p>
<figure class="highlight vim"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line">[root@jamza_vm_lp0_litepaas master]# docker <span class="keyword">ps</span> -<span class="keyword">a</span></span><br><span class="line">CONTAINER ID        IMAGE               COMMAND             CREATED             STATUS              PORTS               NAMES</span><br><span class="line">[root@jamza_vm_lp0_litepaas master]#</span><br><span class="line">[root@jamza_vm_lp0_litepaas master]# docker create -it --privileged=true --net rcm_net1 --name test busybox/x86_64:latest /bin/<span class="keyword">sh</span></span><br><span class="line"><span class="number">9335</span>b9268b7554476727749823e15530fb94b424ec8fb122f308724ac3250036</span><br><span class="line">[root@jamza_vm_lp0_litepaas master]#</span><br><span class="line">[root@jamza_vm_lp0_litepaas master]# docker network connect rcm_net2 test</span><br><span class="line">[root@jamza_vm_lp0_litepaas master]#</span><br><span class="line">[root@jamza_vm_lp0_litepaas master]# docker network connect rcm_net3 test</span><br><span class="line">[root@jamza_vm_lp0_litepaas master]#</span><br><span class="line">[root@jamza_vm_lp0_litepaas master]# docker start -i test</span><br><span class="line">/ #</span><br><span class="line">/ # ifconfig</span><br><span class="line">eth0      Link encap:Ethernet  HWaddr <span class="number">02</span>:<span class="number">42</span>:C0:A8:<span class="number">53</span>:E0</span><br><span class="line">          inet addr:<span class="number">192.168</span>.<span class="number">83.224</span>  Bcas<span class="variable">t:0</span>.<span class="number">0.0</span>.<span class="number">0</span>  Mask:<span class="number">255.255</span>.<span class="number">255.0</span></span><br><span class="line">          inet6 addr: fe80::<span class="number">42</span>:c0ff:fea8:<span class="number">53</span>e0/<span class="number">64</span> Scope:Link</span><br><span class="line">          UP BROADCAST RUNNING MULTICAST  MTU:<span class="number">1500</span>  Metric:<span class="number">1</span></span><br><span class="line">          RX packet<span class="variable">s:0</span> error<span class="variable">s:0</span> dropped:<span class="number">0</span> overrun<span class="variable">s:0</span> frame:<span class="number">0</span></span><br><span class="line">          TX packet<span class="variable">s:6</span> error<span class="variable">s:0</span> dropped:<span class="number">0</span> overrun<span class="variable">s:0</span> carrier:<span class="number">0</span></span><br><span class="line">          collision<span class="variable">s:0</span> txqueuelen:<span class="number">0</span></span><br><span class="line">          RX byte<span class="variable">s:0</span> (<span class="number">0.0</span> B)  TX byte<span class="variable">s:508</span> (<span class="number">508.0</span> B)</span><br><span class="line"></span><br><span class="line">eth1      Link encap:Ethernet  HWaddr <span class="number">02</span>:<span class="number">42</span>:C0:A8:<span class="number">54</span>:E0</span><br><span class="line">          inet addr:<span class="number">192.168</span>.<span class="number">84.224</span>  Bcas<span class="variable">t:0</span>.<span class="number">0.0</span>.<span class="number">0</span>  Mask:<span class="number">255.255</span>.<span class="number">255.0</span></span><br><span class="line">          inet6 addr: fe80::<span class="number">42</span>:c0ff:fea8:<span class="number">54</span>e0/<span class="number">64</span> Scope:Link</span><br><span class="line">          UP BROADCAST RUNNING MULTICAST  MTU:<span class="number">1500</span>  Metric:<span class="number">1</span></span><br><span class="line">          RX packet<span class="variable">s:0</span> error<span class="variable">s:0</span> dropped:<span class="number">0</span> overrun<span class="variable">s:0</span> frame:<span class="number">0</span></span><br><span class="line">          TX packet<span class="variable">s:6</span> error<span class="variable">s:0</span> dropped:<span class="number">0</span> overrun<span class="variable">s:0</span> carrier:<span class="number">0</span></span><br><span class="line">          collision<span class="variable">s:0</span> txqueuelen:<span class="number">0</span></span><br><span class="line">          RX byte<span class="variable">s:0</span> (<span class="number">0.0</span> B)  TX byte<span class="variable">s:508</span> (<span class="number">508.0</span> B)</span><br><span class="line"></span><br><span class="line">eth2      Link encap:Ethernet  HWaddr <span class="number">02</span>:<span class="number">42</span>:C0:A8:<span class="number">55</span>:E0</span><br><span class="line">          inet addr:<span class="number">192.168</span>.<span class="number">85.224</span>  Bcas<span class="variable">t:0</span>.<span class="number">0.0</span>.<span class="number">0</span>  Mask:<span class="number">255.255</span>.<span class="number">255.0</span></span><br><span class="line">          inet6 addr: fe80::<span class="number">42</span>:c0ff:fea8:<span class="number">55</span>e0/<span class="number">64</span> Scope:Link</span><br><span class="line">          UP BROADCAST RUNNING MULTICAST  MTU:<span class="number">1500</span>  Metric:<span class="number">1</span></span><br><span class="line">          RX packet<span class="variable">s:0</span> error<span class="variable">s:0</span> dropped:<span class="number">0</span> overrun<span class="variable">s:0</span> frame:<span class="number">0</span></span><br><span class="line">          TX packet<span class="variable">s:6</span> error<span class="variable">s:0</span> dropped:<span class="number">0</span> overrun<span class="variable">s:0</span> carrier:<span class="number">0</span></span><br><span class="line">          collision<span class="variable">s:0</span> txqueuelen:<span class="number">0</span></span><br><span class="line">          RX byte<span class="variable">s:0</span> (<span class="number">0.0</span> B)  TX byte<span class="variable">s:508</span> (<span class="number">508.0</span> B)</span><br><span class="line"></span><br><span class="line"><span class="keyword">lo</span>        Link encap:Local Loopback</span><br><span class="line">          inet addr:<span class="number">127.0</span>.<span class="number">0.1</span>  Mask:<span class="number">255.0</span>.<span class="number">0.0</span></span><br><span class="line">          inet6 addr: ::<span class="number">1</span>/<span class="number">128</span> Scope:Host</span><br><span class="line">          UP LOOPBACK RUNNING  MTU:<span class="number">65536</span>  Metric:<span class="number">1</span></span><br><span class="line">          RX packet<span class="variable">s:0</span> error<span class="variable">s:0</span> dropped:<span class="number">0</span> overrun<span class="variable">s:0</span> frame:<span class="number">0</span></span><br><span class="line">          TX packet<span class="variable">s:0</span> error<span class="variable">s:0</span> dropped:<span class="number">0</span> overrun<span class="variable">s:0</span> carrier:<span class="number">0</span></span><br><span class="line">          collision<span class="variable">s:0</span> txqueuelen:<span class="number">1</span></span><br><span class="line">          RX byte<span class="variable">s:0</span> (<span class="number">0.0</span> B)  TX byte<span class="variable">s:0</span> (<span class="number">0.0</span> B)</span><br><span class="line"></span><br><span class="line">/ #</span><br></pre></td></tr></table></figure>

<h2 id="主控与线卡环境中容器-ping-测试"><a href="#主控与线卡环境中容器-ping-测试" class="headerlink" title="主控与线卡环境中容器 ping 测试"></a>主控与线卡环境中容器 ping 测试</h2><p>在主控环境中的容器内，ping 线卡环境中的容器 ip 地址，以及在线卡环境中的容器内，ping 主控环境中的容器 ip 地址，显示均能够 ping 通：</p>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#主控环境中的容器内，ping线卡环境上的容器ip地址</span></span><br><span class="line">/ #</span><br><span class="line">/ #<span class="built_in"> ping </span>192.168.83.224<span class="built_in"></span></span><br><span class="line"><span class="built_in">PING </span>192.168.83.224 (192.168.83.224): 56 data bytes</span><br><span class="line">64 bytes <span class="keyword">from</span> 192.168.83.224: <span class="attribute">seq</span>=0 <span class="attribute">ttl</span>=64 <span class="attribute">time</span>=0.421 ms</span><br><span class="line">64 bytes <span class="keyword">from</span> 192.168.83.224: <span class="attribute">seq</span>=1 <span class="attribute">ttl</span>=64 <span class="attribute">time</span>=0.544 ms</span><br><span class="line">64 bytes <span class="keyword">from</span> 192.168.83.224: <span class="attribute">seq</span>=2 <span class="attribute">ttl</span>=64 <span class="attribute">time</span>=0.412 ms</span><br><span class="line">64 bytes <span class="keyword">from</span> 192.168.83.224: <span class="attribute">seq</span>=3 <span class="attribute">ttl</span>=64 <span class="attribute">time</span>=0.383 ms</span><br><span class="line">^C</span><br><span class="line">--- 192.168.83.224<span class="built_in"> ping </span>statistics ---</span><br><span class="line">4 packets transmitted, 4 packets received, 0% packet loss</span><br><span class="line">round-trip min/avg/max = 0.383/0.440/0.544 ms</span><br><span class="line">/ #</span><br><span class="line">/ #<span class="built_in"> ping </span>192.168.84.224<span class="built_in"></span></span><br><span class="line"><span class="built_in">PING </span>192.168.84.224 (192.168.84.224): 56 data bytes</span><br><span class="line">64 bytes <span class="keyword">from</span> 192.168.84.224: <span class="attribute">seq</span>=0 <span class="attribute">ttl</span>=64 <span class="attribute">time</span>=0.458 ms</span><br><span class="line">64 bytes <span class="keyword">from</span> 192.168.84.224: <span class="attribute">seq</span>=1 <span class="attribute">ttl</span>=64 <span class="attribute">time</span>=0.586 ms</span><br><span class="line">64 bytes <span class="keyword">from</span> 192.168.84.224: <span class="attribute">seq</span>=2 <span class="attribute">ttl</span>=64 <span class="attribute">time</span>=0.560 ms</span><br><span class="line">64 bytes <span class="keyword">from</span> 192.168.84.224: <span class="attribute">seq</span>=3 <span class="attribute">ttl</span>=64 <span class="attribute">time</span>=0.333 ms</span><br><span class="line">^C</span><br><span class="line">--- 192.168.84.224<span class="built_in"> ping </span>statistics ---</span><br><span class="line">4 packets transmitted, 4 packets received, 0% packet loss</span><br><span class="line">round-trip min/avg/max = 0.333/0.484/0.586 ms</span><br><span class="line">/ #</span><br><span class="line">/ #<span class="built_in"> ping </span>192.168.85.224<span class="built_in"></span></span><br><span class="line"><span class="built_in">PING </span>192.168.85.224 (192.168.85.224): 56 data bytes</span><br><span class="line">64 bytes <span class="keyword">from</span> 192.168.85.224: <span class="attribute">seq</span>=0 <span class="attribute">ttl</span>=64 <span class="attribute">time</span>=0.341 ms</span><br><span class="line">64 bytes <span class="keyword">from</span> 192.168.85.224: <span class="attribute">seq</span>=1 <span class="attribute">ttl</span>=64 <span class="attribute">time</span>=0.465 ms</span><br><span class="line">64 bytes <span class="keyword">from</span> 192.168.85.224: <span class="attribute">seq</span>=2 <span class="attribute">ttl</span>=64 <span class="attribute">time</span>=0.266 ms</span><br><span class="line">64 bytes <span class="keyword">from</span> 192.168.85.224: <span class="attribute">seq</span>=3 <span class="attribute">ttl</span>=64 <span class="attribute">time</span>=0.514 ms</span><br><span class="line">^C</span><br><span class="line">--- 192.168.85.224<span class="built_in"> ping </span>statistics ---</span><br><span class="line">4 packets transmitted, 4 packets received, 0% packet loss</span><br><span class="line">round-trip min/avg/max = 0.266/0.396/0.514 ms</span><br><span class="line">/ #</span><br><span class="line"></span><br><span class="line"><span class="comment">#线卡环境中的容器内，ping主控环境上的容器ip地址</span></span><br><span class="line">/ #</span><br><span class="line">/ #<span class="built_in"> ping </span>192.168.83.240<span class="built_in"></span></span><br><span class="line"><span class="built_in">PING </span>192.168.83.240 (192.168.83.240): 56 data bytes</span><br><span class="line">64 bytes <span class="keyword">from</span> 192.168.83.240: <span class="attribute">seq</span>=0 <span class="attribute">ttl</span>=64 <span class="attribute">time</span>=0.428 ms</span><br><span class="line">64 bytes <span class="keyword">from</span> 192.168.83.240: <span class="attribute">seq</span>=1 <span class="attribute">ttl</span>=64 <span class="attribute">time</span>=0.415 ms</span><br><span class="line">64 bytes <span class="keyword">from</span> 192.168.83.240: <span class="attribute">seq</span>=2 <span class="attribute">ttl</span>=64 <span class="attribute">time</span>=0.384 ms</span><br><span class="line">64 bytes <span class="keyword">from</span> 192.168.83.240: <span class="attribute">seq</span>=3 <span class="attribute">ttl</span>=64 <span class="attribute">time</span>=0.455 ms</span><br><span class="line">^C</span><br><span class="line">--- 192.168.83.240<span class="built_in"> ping </span>statistics ---</span><br><span class="line">4 packets transmitted, 4 packets received, 0% packet loss</span><br><span class="line">round-trip min/avg/max = 0.384/0.420/0.455 ms</span><br><span class="line">/ #</span><br><span class="line">/ #<span class="built_in"> ping </span>192.168.84.240<span class="built_in"></span></span><br><span class="line"><span class="built_in">PING </span>192.168.84.240 (192.168.84.240): 56 data bytes</span><br><span class="line">64 bytes <span class="keyword">from</span> 192.168.84.240: <span class="attribute">seq</span>=0 <span class="attribute">ttl</span>=64 <span class="attribute">time</span>=0.356 ms</span><br><span class="line">64 bytes <span class="keyword">from</span> 192.168.84.240: <span class="attribute">seq</span>=1 <span class="attribute">ttl</span>=64 <span class="attribute">time</span>=0.372 ms</span><br><span class="line">64 bytes <span class="keyword">from</span> 192.168.84.240: <span class="attribute">seq</span>=2 <span class="attribute">ttl</span>=64 <span class="attribute">time</span>=0.415 ms</span><br><span class="line">64 bytes <span class="keyword">from</span> 192.168.84.240: <span class="attribute">seq</span>=3 <span class="attribute">ttl</span>=64 <span class="attribute">time</span>=0.501 ms</span><br><span class="line">^C</span><br><span class="line">--- 192.168.84.240<span class="built_in"> ping </span>statistics ---</span><br><span class="line">4 packets transmitted, 4 packets received, 0% packet loss</span><br><span class="line">round-trip min/avg/max = 0.356/0.411/0.501 ms</span><br><span class="line">/ #</span><br><span class="line">/ #<span class="built_in"> ping </span>192.168.85.240<span class="built_in"></span></span><br><span class="line"><span class="built_in">PING </span>192.168.85.240 (192.168.85.240): 56 data bytes</span><br><span class="line">64 bytes <span class="keyword">from</span> 192.168.85.240: <span class="attribute">seq</span>=0 <span class="attribute">ttl</span>=64 <span class="attribute">time</span>=0.241 ms</span><br><span class="line">64 bytes <span class="keyword">from</span> 192.168.85.240: <span class="attribute">seq</span>=1 <span class="attribute">ttl</span>=64 <span class="attribute">time</span>=0.340 ms</span><br><span class="line">64 bytes <span class="keyword">from</span> 192.168.85.240: <span class="attribute">seq</span>=2 <span class="attribute">ttl</span>=64 <span class="attribute">time</span>=0.449 ms</span><br><span class="line">64 bytes <span class="keyword">from</span> 192.168.85.240: <span class="attribute">seq</span>=3 <span class="attribute">ttl</span>=64 <span class="attribute">time</span>=0.286 ms</span><br><span class="line">^C</span><br><span class="line">--- 192.168.85.240<span class="built_in"> ping </span>statistics ---</span><br><span class="line">4 packets transmitted, 4 packets received, 0% packet loss</span><br><span class="line">round-trip min/avg/max = 0.241/0.329/0.449 ms</span><br><span class="line">/ #</span><br></pre></td></tr></table></figure>
        </div>

        
            <section class="post-copyright">
                
                
                
                

            </section>
        
        <section class="post-tags">
            <div>
                <span>Tag(s):</span>
                <span class="tag">
                    
                    
                        <a href="/tags/docker/"># docker</a>
                    
                        
                </span>
            </div>
            <div>
                <a href="javascript:window.history.back();">back</a>
                <span>· </span>
                <a href="/">home</a>
            </div>
        </section>
        <section class="post-nav">
            
                <a class="prev" rel="prev" href="/2021/05/22/Consul%E4%B8%8E%E8%B7%A8%E4%B8%BB%E6%9C%BADocker%E9%80%9A%E4%BF%A1/">Consul 与跨主机 Docker 通信</a>
            
            
            <a class="next" rel="next" href="/2021/05/22/%E7%9B%B4%E6%8E%A5%E8%B7%AF%E7%94%B1%E6%96%B9%E5%BC%8F%E5%AE%9E%E7%8E%B0%E8%B7%A8%E4%B8%BB%E6%9C%BADocker%E9%80%9A%E4%BF%A1/">直接路由方式实现跨主机 Docker 通信</a>
            
        </section>


    </article>
</div>

        </div>
        <footer id="footer" class="footer">
    <div class="copyright">
        <span>© Jamza | Powered by <a href="https://hexo.io" target="_blank">Hexo</a> & <a href="https://github.com/Siricee/hexo-theme-Chic" target="_blank">Chic</a></span>
    </div>
</footer>

    </div>
</body>
</html>
