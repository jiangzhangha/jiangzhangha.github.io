<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
<meta name="viewport"
      content="width=device-width, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0">
<meta http-equiv="X-UA-Compatible" content="ie=edge">

    <meta name="author" content="Jamza">





<title>自定义网桥模式实现跨主机 Docker 通信 | Jamza&#39;s Blog</title>



    <link rel="icon" href="/image/head.jpg">




    <!-- stylesheets list from _config.yml -->
    
    <link rel="stylesheet" href="/css/style.css">
    



    <!-- scripts list from _config.yml -->
    
    <script src="/js/script.js"></script>
    
    <script src="/js/tocbot.min.js"></script>
    



    
    
        
    


<meta name="generator" content="Hexo 5.4.0"></head>
<body>
    <div class="wrapper">
        <header>
    <nav class="navbar">
        <div class="container">
            <div class="navbar-header header-logo"><a href="/">Jamza&#39;s Blog</a></div>
            <div class="menu navbar-right">
                
                    <a class="menu-item" href="/archives">Posts</a>
                
                    <a class="menu-item" href="/category">Categories</a>
                
                    <a class="menu-item" href="/tag">Tags</a>
                
                    <a class="menu-item" href="/about">About</a>
                
                <input id="switch_default" type="checkbox" class="switch_default">
                <label for="switch_default" class="toggleBtn"></label>
            </div>
        </div>
    </nav>

    
    <nav class="navbar-mobile" id="nav-mobile">
        <div class="container">
            <div class="navbar-header">
                <div>
                    <a href="/">Jamza&#39;s Blog</a><a id="mobile-toggle-theme">·&nbsp;Light</a>
                </div>
                <div class="menu-toggle" onclick="mobileBtn()">&#9776; Menu</div>
            </div>
            <div class="menu" id="mobile-menu">
                
                    <a class="menu-item" href="/archives">Posts</a>
                
                    <a class="menu-item" href="/category">Categories</a>
                
                    <a class="menu-item" href="/tag">Tags</a>
                
                    <a class="menu-item" href="/about">About</a>
                
            </div>
        </div>
    </nav>

</header>
<script>
    var mobileBtn = function f() {
        var toggleMenu = document.getElementsByClassName("menu-toggle")[0];
        var mobileMenu = document.getElementById("mobile-menu");
        if(toggleMenu.classList.contains("active")){
           toggleMenu.classList.remove("active")
            mobileMenu.classList.remove("active")
        }else{
            toggleMenu.classList.add("active")
            mobileMenu.classList.add("active")
        }
    }
</script>
        <div class="main">
            <div class="container">
    
    

    
    <article class="post-wrap">
        <header class="post-header">
            <h1 class="post-title">自定义网桥模式实现跨主机 Docker 通信</h1>
            
                <div class="post-meta">
                    
                        Author: <a itemprop="author" rel="author" href="/">Jamza</a>
                    

                    
                        <span class="post-time">
                        Date: <a href="#">May 22, 2021&nbsp;&nbsp;12:02:06</a>
                        </span>
                    
                    
                        <span class="post-category">
                    Category:
                            
                                <a href="/categories/%E4%BA%91%E8%AE%A1%E7%AE%97/">云计算</a>
                            
                        </span>
                    
                </div>
            
        </header>

        <div class="post-content">
            <h1 id="自定义网桥模式实现跨主机-Docker-通信"><a href="#自定义网桥模式实现跨主机-Docker-通信" class="headerlink" title="自定义网桥模式实现跨主机 Docker 通信"></a>自定义网桥模式实现跨主机 Docker 通信</h1><h2 id="概念"><a href="#概念" class="headerlink" title="概念"></a>概念</h2><p>不同主机上的 Docker 容器通过某些方法可实现跨主机通信，但是一般不同主机上的 Docker 容器内的 IP 地址不是处于同一个网段，但是可以通过自定义网桥的方式，将不同主机的自定义网桥设定为同一个网段，并桥接主机上的网卡，实现跨主机通信。</p>
<h2 id="地址划分"><a href="#地址划分" class="headerlink" title="地址划分"></a>地址划分</h2><h3 id="主控："><a href="#主控：" class="headerlink" title="主控："></a>主控：</h3><p>ip 地址：192.168.84.83</p>
<p>网卡：eth20</p>
<p>网关：192.168.84.1</p>
<p>自定义网桥名称：br1</p>
<p>自定义网桥地址：192.168.84.1</p>
<p>主控上容器 ip 地址池：192.168.84.224/28</p>
<h3 id="线卡"><a href="#线卡" class="headerlink" title="线卡"></a>线卡</h3><p>ip 地址：192.168.84.85</p>
<p>网卡：eth20</p>
<p>网关：192.168.84.1</p>
<p>自定义网桥名称：br1</p>
<p>自定义网桥地址：192.168.84.1</p>
<p>主控上容器 ip 地址池：192.168.84.240/28</p>
<h2 id="主控设置"><a href="#主控设置" class="headerlink" title="主控设置"></a>主控设置</h2><p>在设置之前，主控中没有 br 网桥，ip 路由显示 192.168.84.0/24 网段路由通过网卡 eth20 端：</p>
<figure class="highlight pf"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line">[root@jamza_vm_master_litepaas master]<span class="comment"># ip addr</span></span><br><span class="line"><span class="number">1</span>: lo: <span class="variable">&lt;LOOPBACK,UP,LOWER_UP&gt;</span> mtu <span class="number">65536</span> qdisc noqueue <span class="keyword">state</span> UNKNOWN qlen <span class="number">1</span></span><br><span class="line">    link/loopback <span class="number">00</span>:<span class="number">00</span>:<span class="number">00</span>:<span class="number">00</span>:<span class="number">00</span>:<span class="number">00</span> brd <span class="number">00</span>:<span class="number">00</span>:<span class="number">00</span>:<span class="number">00</span>:<span class="number">00</span>:<span class="number">00</span></span><br><span class="line">    <span class="keyword">inet</span> <span class="number">127.0</span>.<span class="number">0.1</span>/<span class="number">8</span> scope host lo</span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">    <span class="keyword">inet6</span> ::<span class="number">1</span>/<span class="number">128</span> scope host</span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line"><span class="number">2</span>: eth0: <span class="variable">&lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt;</span> mtu <span class="number">1500</span> qdisc pfifo_fast <span class="keyword">state</span> UP qlen <span class="number">1000</span></span><br><span class="line">    link/ether <span class="number">52</span>:<span class="number">54</span>:<span class="number">83</span>:aa:bb:<span class="number">00</span> brd ff:ff:ff:ff:ff:ff</span><br><span class="line">    <span class="keyword">inet</span> <span class="number">192.168</span>.<span class="number">83.83</span>/<span class="number">24</span> brd <span class="number">192.168</span>.<span class="number">83.255</span> scope <span class="keyword">global</span> eth0</span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">    <span class="keyword">inet6</span> fe80::<span class="number">5054</span>:<span class="number">83</span>ff:feaa:bb00/<span class="number">64</span> scope link</span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line"><span class="number">3</span>: eth20: <span class="variable">&lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt;</span> mtu <span class="number">1500</span> qdisc pfifo_fast <span class="keyword">state</span> UP qlen <span class="number">1000</span></span><br><span class="line">    link/ether <span class="number">52</span>:<span class="number">54</span>:<span class="number">83</span>:aa:bb:<span class="number">20</span> brd ff:ff:ff:ff:ff:ff</span><br><span class="line">    <span class="keyword">inet</span> <span class="number">192.168</span>.<span class="number">84.83</span>/<span class="number">24</span> brd <span class="number">192.168</span>.<span class="number">84.255</span> scope <span class="keyword">global</span> eth20</span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">    <span class="keyword">inet6</span> fe80::<span class="number">5054</span>:<span class="number">83</span>ff:feaa:bb20/<span class="number">64</span> scope link</span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line"><span class="number">4</span>: eth21: <span class="variable">&lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt;</span> mtu <span class="number">1500</span> qdisc pfifo_fast <span class="keyword">state</span> UP qlen <span class="number">1000</span></span><br><span class="line">    link/ether <span class="number">52</span>:<span class="number">54</span>:<span class="number">83</span>:aa:bb:<span class="number">21</span> brd ff:ff:ff:ff:ff:ff</span><br><span class="line">    <span class="keyword">inet</span> <span class="number">192.168</span>.<span class="number">85.83</span>/<span class="number">24</span> brd <span class="number">192.168</span>.<span class="number">85.255</span> scope <span class="keyword">global</span> eth21</span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">    <span class="keyword">inet6</span> fe80::<span class="number">5054</span>:<span class="number">83</span>ff:feaa:bb21/<span class="number">64</span> scope link</span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line"><span class="number">5</span>: docker_gwbridge: <span class="variable">&lt;NO-CARRIER,BROADCAST,MULTICAST,UP&gt;</span> mtu <span class="number">1500</span> qdisc noqueue <span class="keyword">state</span> DOWN</span><br><span class="line">    link/ether <span class="number">02</span>:<span class="number">42</span>:<span class="number">0</span>c:<span class="number">8</span>b:<span class="number">82</span>:cc brd ff:ff:ff:ff:ff:ff</span><br><span class="line">    <span class="keyword">inet</span> <span class="number">172.18</span>.<span class="number">0.1</span>/<span class="number">20</span> scope <span class="keyword">global</span> docker_gwbridge</span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line"><span class="number">6</span>: docker0: <span class="variable">&lt;NO-CARRIER,BROADCAST,MULTICAST,UP&gt;</span> mtu <span class="number">1500</span> qdisc noqueue <span class="keyword">state</span> DOWN</span><br><span class="line">    link/ether <span class="number">02</span>:<span class="number">42</span>:<span class="number">0</span>f:<span class="number">34</span>:eb:<span class="number">4</span>b brd ff:ff:ff:ff:ff:ff</span><br><span class="line">    <span class="keyword">inet</span> <span class="number">10.76</span>.<span class="number">84.11</span>/<span class="number">24</span> scope <span class="keyword">global</span> docker0</span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">    <span class="keyword">inet6</span> fe80::<span class="number">42</span>:fff:fe34:eb4b/<span class="number">64</span> scope link</span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">[root@jamza_vm_master_litepaas master]<span class="comment">#</span></span><br><span class="line">[root@jamza_vm_master_litepaas master]<span class="comment"># ip route</span></span><br><span class="line"><span class="keyword">default</span> via <span class="number">192.168</span>.<span class="number">83.1</span> dev eth0</span><br><span class="line"><span class="number">10.76</span>.<span class="number">84.0</span>/<span class="number">24</span> dev docker0 <span class="keyword">proto</span> kernel scope link src <span class="number">10.76</span>.<span class="number">84.11</span></span><br><span class="line"><span class="number">169.254</span>.<span class="number">0.0</span>/<span class="number">16</span> dev eth0 scope link metric <span class="number">1002</span></span><br><span class="line"><span class="number">169.254</span>.<span class="number">0.0</span>/<span class="number">16</span> dev eth20 scope link metric <span class="number">1003</span></span><br><span class="line"><span class="number">169.254</span>.<span class="number">0.0</span>/<span class="number">16</span> dev eth21 scope link metric <span class="number">1004</span></span><br><span class="line"><span class="number">172.18</span>.<span class="number">0.0</span>/<span class="number">20</span> dev docker_gwbridge <span class="keyword">proto</span> kernel scope link src <span class="number">172.18</span>.<span class="number">0.1</span></span><br><span class="line"><span class="number">192.168</span>.<span class="number">83.0</span>/<span class="number">24</span> dev eth0 <span class="keyword">proto</span> kernel scope link src <span class="number">192.168</span>.<span class="number">83.83</span></span><br><span class="line"><span class="number">192.168</span>.<span class="number">84.0</span>/<span class="number">24</span> dev eth20 <span class="keyword">proto</span> kernel scope link src <span class="number">192.168</span>.<span class="number">84.83</span></span><br><span class="line"><span class="number">192.168</span>.<span class="number">85.0</span>/<span class="number">24</span> dev eth21 <span class="keyword">proto</span> kernel scope link src <span class="number">192.168</span>.<span class="number">85.83</span></span><br><span class="line">[root@jamza_vm_master_litepaas master]<span class="comment">#</span></span><br></pre></td></tr></table></figure>

<p>在主控上创建一个网桥，为网桥分配 ip 地址，并将自定义的网桥桥接本地的网卡 eth20：</p>
<figure class="highlight autoit"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">[root<span class="symbol">@jamza_vm_master_litepaas</span> master]<span class="meta">#</span></span><br><span class="line">[root<span class="symbol">@jamza_vm_master_litepaas</span> master]<span class="meta"># brctl addbr br1</span></span><br><span class="line">[root<span class="symbol">@jamza_vm_master_litepaas</span> master]<span class="meta">#</span></span><br><span class="line">[root<span class="symbol">@jamza_vm_master_litepaas</span> master]<span class="meta"># ifconfig br1 192.168.84.1 netmask 255.255.255.0</span></span><br><span class="line">[root<span class="symbol">@jamza_vm_master_litepaas</span> master]<span class="meta">#</span></span><br><span class="line">[root<span class="symbol">@jamza_vm_master_litepaas</span> master]<span class="meta"># brctl addif br1 eth20</span></span><br><span class="line">[root<span class="symbol">@jamza_vm_master_litepaas</span> master]<span class="meta">#</span></span><br><span class="line">[root<span class="symbol">@jamza_vm_master_litepaas</span> master]<span class="meta">#</span></span><br></pre></td></tr></table></figure>

<p>修改 docker 的服务端配置，使得 docker 默认连接自定义的网桥 br1，而不是默认的 docker0 网桥，并配置主控上的容器 ip 地址池为 192.168.84.224/28，以防止主控上的容器 ip 地址与线卡上的容器 ip 地址冲突，注意，设置默认网桥与地址池的字段分别是 bridge 与 fixed-cidr，然后重启 docker 服务端：</p>
<figure class="highlight autoit"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">[root<span class="symbol">@jamza_vm_master_litepaas</span> master]<span class="meta">#</span></span><br><span class="line">[root<span class="symbol">@jamza_vm_master_litepaas</span> master]<span class="meta"># vi /etc/docker/daemon.json</span></span><br><span class="line">[root<span class="symbol">@jamza_vm_master_litepaas</span> master]<span class="meta">#</span></span><br><span class="line">[root<span class="symbol">@jamza_vm_master_litepaas</span> master]<span class="meta"># cat /etc/docker/daemon.json</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="string">&quot;bridge&quot;</span>:<span class="string">&quot;br1&quot;</span>,</span><br><span class="line"><span class="string">&quot;fixed-cidr&quot;</span>:<span class="string">&quot;192.168.84.224/28&quot;</span>,</span><br><span class="line"><span class="string">&quot;cpu-rt-runtime&quot;</span>:<span class="number">800000</span>,</span><br><span class="line"><span class="string">&quot;cpu-rt-period&quot;</span>:<span class="number">1000000</span>,</span><br><span class="line"><span class="string">&quot;storage-driver&quot;</span>:<span class="string">&quot;overlay2&quot;</span>,</span><br><span class="line"><span class="string">&quot;storage-opts&quot;</span>:[<span class="string">&quot;overlay2.override_kernel_check=true&quot;</span>]</span><br><span class="line">&#125;</span><br><span class="line">&#123; <span class="string">&quot;insecure-registries&quot;</span>:[<span class="string">&quot;172.18.0.3:5000&quot;</span>]&#125;</span><br><span class="line">[root<span class="symbol">@jamza_vm_master_litepaas</span> master]<span class="meta">#</span></span><br><span class="line">[root<span class="symbol">@jamza_vm_master_litepaas</span> master]<span class="meta">#</span></span><br><span class="line">[root<span class="symbol">@jamza_vm_master_litepaas</span> master]<span class="meta"># systemctl daemon-reload</span></span><br><span class="line">[root<span class="symbol">@jamza_vm_master_litepaas</span> master]<span class="meta"># service docker restart</span></span><br><span class="line">Redirecting <span class="keyword">to</span> /bin/systemctl restart docker.service</span><br><span class="line">[root<span class="symbol">@jamza_vm_master_litepaas</span> master]<span class="meta">#</span></span><br></pre></td></tr></table></figure>

<p>此时查看主控上的 ip 地址，出现 br1 网桥：</p>
<figure class="highlight pf"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line">[root@jamza_vm_master_litepaas master]<span class="comment"># ip addr</span></span><br><span class="line"><span class="number">1</span>: lo: <span class="variable">&lt;LOOPBACK,UP,LOWER_UP&gt;</span> mtu <span class="number">65536</span> qdisc noqueue <span class="keyword">state</span> UNKNOWN qlen <span class="number">1</span></span><br><span class="line">    link/loopback <span class="number">00</span>:<span class="number">00</span>:<span class="number">00</span>:<span class="number">00</span>:<span class="number">00</span>:<span class="number">00</span> brd <span class="number">00</span>:<span class="number">00</span>:<span class="number">00</span>:<span class="number">00</span>:<span class="number">00</span>:<span class="number">00</span></span><br><span class="line">    <span class="keyword">inet</span> <span class="number">127.0</span>.<span class="number">0.1</span>/<span class="number">8</span> scope host lo</span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">    <span class="keyword">inet6</span> ::<span class="number">1</span>/<span class="number">128</span> scope host</span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line"><span class="number">2</span>: eth0: <span class="variable">&lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt;</span> mtu <span class="number">1500</span> qdisc pfifo_fast <span class="keyword">state</span> UP qlen <span class="number">1000</span></span><br><span class="line">    link/ether <span class="number">52</span>:<span class="number">54</span>:<span class="number">83</span>:aa:bb:<span class="number">00</span> brd ff:ff:ff:ff:ff:ff</span><br><span class="line">    <span class="keyword">inet</span> <span class="number">192.168</span>.<span class="number">83.83</span>/<span class="number">24</span> brd <span class="number">192.168</span>.<span class="number">83.255</span> scope <span class="keyword">global</span> eth0</span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">    <span class="keyword">inet6</span> fe80::<span class="number">5054</span>:<span class="number">83</span>ff:feaa:bb00/<span class="number">64</span> scope link</span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line"><span class="number">3</span>: eth20: <span class="variable">&lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt;</span> mtu <span class="number">1500</span> qdisc pfifo_fast master br1 <span class="keyword">state</span> UP qlen <span class="number">1000</span></span><br><span class="line">    link/ether <span class="number">52</span>:<span class="number">54</span>:<span class="number">83</span>:aa:bb:<span class="number">20</span> brd ff:ff:ff:ff:ff:ff</span><br><span class="line">    <span class="keyword">inet</span> <span class="number">192.168</span>.<span class="number">84.83</span>/<span class="number">24</span> brd <span class="number">192.168</span>.<span class="number">84.255</span> scope <span class="keyword">global</span> eth20</span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">    <span class="keyword">inet6</span> fe80::<span class="number">5054</span>:<span class="number">83</span>ff:feaa:bb20/<span class="number">64</span> scope link</span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line"><span class="number">4</span>: eth21: <span class="variable">&lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt;</span> mtu <span class="number">1500</span> qdisc pfifo_fast <span class="keyword">state</span> UP qlen <span class="number">1000</span></span><br><span class="line">    link/ether <span class="number">52</span>:<span class="number">54</span>:<span class="number">83</span>:aa:bb:<span class="number">21</span> brd ff:ff:ff:ff:ff:ff</span><br><span class="line">    <span class="keyword">inet</span> <span class="number">192.168</span>.<span class="number">85.83</span>/<span class="number">24</span> brd <span class="number">192.168</span>.<span class="number">85.255</span> scope <span class="keyword">global</span> eth21</span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">    <span class="keyword">inet6</span> fe80::<span class="number">5054</span>:<span class="number">83</span>ff:feaa:bb21/<span class="number">64</span> scope link</span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line"><span class="number">5</span>: docker_gwbridge: <span class="variable">&lt;NO-CARRIER,BROADCAST,MULTICAST,UP&gt;</span> mtu <span class="number">1500</span> qdisc noqueue <span class="keyword">state</span> DOWN</span><br><span class="line">    link/ether <span class="number">02</span>:<span class="number">42</span>:<span class="number">0</span>c:<span class="number">8</span>b:<span class="number">82</span>:cc brd ff:ff:ff:ff:ff:ff</span><br><span class="line">    <span class="keyword">inet</span> <span class="number">172.18</span>.<span class="number">0.1</span>/<span class="number">20</span> scope <span class="keyword">global</span> docker_gwbridge</span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line"><span class="number">6</span>: docker0: <span class="variable">&lt;NO-CARRIER,BROADCAST,MULTICAST,UP&gt;</span> mtu <span class="number">1500</span> qdisc noqueue <span class="keyword">state</span> DOWN</span><br><span class="line">    link/ether <span class="number">02</span>:<span class="number">42</span>:<span class="number">0</span>f:<span class="number">34</span>:eb:<span class="number">4</span>b brd ff:ff:ff:ff:ff:ff</span><br><span class="line">    <span class="keyword">inet</span> <span class="number">10.76</span>.<span class="number">84.11</span>/<span class="number">24</span> scope <span class="keyword">global</span> docker0</span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">    <span class="keyword">inet6</span> fe80::<span class="number">42</span>:fff:fe34:eb4b/<span class="number">64</span> scope link</span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line"><span class="number">135</span>: br1: <span class="variable">&lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt;</span> mtu <span class="number">1500</span> qdisc noqueue <span class="keyword">state</span> UP qlen <span class="number">1000</span></span><br><span class="line">    link/ether <span class="number">52</span>:<span class="number">54</span>:<span class="number">83</span>:aa:bb:<span class="number">20</span> brd ff:ff:ff:ff:ff:ff</span><br><span class="line">    <span class="keyword">inet</span> <span class="number">192.168</span>.<span class="number">84.1</span>/<span class="number">24</span> brd <span class="number">192.168</span>.<span class="number">84.255</span> scope <span class="keyword">global</span> br1</span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">    <span class="keyword">inet6</span> fe80::f0e1:fbff:fe3d:c088/<span class="number">64</span> scope link</span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">[root@jamza_vm_master_litepaas master]<span class="comment">#</span></span><br></pre></td></tr></table></figure>

<p>查看主控上的 ip 路由信息，注意这里出现了两个 192.168.84.0/24 网段的路由路径：</p>
<figure class="highlight accesslog"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">[root@jamza_vm_master_litepaas master]</span># ip route</span><br><span class="line">default via <span class="number">192</span>.<span class="number">168</span>.<span class="number">83</span>.<span class="number">1</span> dev eth0</span><br><span class="line"><span class="number">10.76.84.0</span>/<span class="number">24</span> dev docker0 proto kernel scope link src <span class="number">10</span>.<span class="number">76</span>.<span class="number">84</span>.<span class="number">11</span></span><br><span class="line"><span class="number">169.254.0.0</span>/<span class="number">16</span> dev eth0 scope link metric <span class="number">1002</span></span><br><span class="line"><span class="number">169.254.0.0</span>/<span class="number">16</span> dev eth20 scope link metric <span class="number">1003</span></span><br><span class="line"><span class="number">169.254.0.0</span>/<span class="number">16</span> dev eth21 scope link metric <span class="number">1004</span></span><br><span class="line"><span class="number">172.18.0.0</span>/<span class="number">20</span> dev docker_gwbridge proto kernel scope link src <span class="number">172</span>.<span class="number">18</span>.<span class="number">0</span>.<span class="number">1</span></span><br><span class="line"><span class="number">192.168.83.0</span>/<span class="number">24</span> dev eth0 proto kernel scope link src <span class="number">192</span>.<span class="number">168</span>.<span class="number">83</span>.<span class="number">83</span></span><br><span class="line"><span class="number">192.168.84.0</span>/<span class="number">24</span> dev eth20 proto kernel scope link src <span class="number">192</span>.<span class="number">168</span>.<span class="number">84</span>.<span class="number">83</span></span><br><span class="line"><span class="number">192.168.84.0</span>/<span class="number">24</span> dev br1 proto kernel scope link src <span class="number">192</span>.<span class="number">168</span>.<span class="number">84</span>.<span class="number">1</span></span><br><span class="line"><span class="number">192.168.85.0</span>/<span class="number">24</span> dev eth21 proto kernel scope link src <span class="number">192</span>.<span class="number">168</span>.<span class="number">85</span>.<span class="number">83</span></span><br><span class="line"><span class="string">[root@jamza_vm_master_litepaas master]</span>#</span><br></pre></td></tr></table></figure>

<h2 id="线卡设置"><a href="#线卡设置" class="headerlink" title="线卡设置"></a>线卡设置</h2><p>在设置之前，主控中没有 br 网桥，ip 路由显示 192.168.84.0/24 网段路由通过网卡 eth20 端：</p>
<figure class="highlight pf"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line">[root@jamza_vm_lp0_litepaas master]<span class="comment"># ip addr</span></span><br><span class="line"><span class="number">1</span>: lo: <span class="variable">&lt;LOOPBACK,UP,LOWER_UP&gt;</span> mtu <span class="number">65536</span> qdisc noqueue <span class="keyword">state</span> UNKNOWN qlen <span class="number">1</span></span><br><span class="line">    link/loopback <span class="number">00</span>:<span class="number">00</span>:<span class="number">00</span>:<span class="number">00</span>:<span class="number">00</span>:<span class="number">00</span> brd <span class="number">00</span>:<span class="number">00</span>:<span class="number">00</span>:<span class="number">00</span>:<span class="number">00</span>:<span class="number">00</span></span><br><span class="line">    <span class="keyword">inet</span> <span class="number">127.0</span>.<span class="number">0.1</span>/<span class="number">8</span> scope host lo</span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">    <span class="keyword">inet6</span> ::<span class="number">1</span>/<span class="number">128</span> scope host</span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line"><span class="number">2</span>: eth0: <span class="variable">&lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt;</span> mtu <span class="number">1500</span> qdisc pfifo_fast <span class="keyword">state</span> UP qlen <span class="number">1000</span></span><br><span class="line">    link/ether <span class="number">52</span>:<span class="number">54</span>:<span class="number">83</span>:cc:dd:<span class="number">00</span> brd ff:ff:ff:ff:ff:ff</span><br><span class="line">    <span class="keyword">inet</span> <span class="number">192.168</span>.<span class="number">83.85</span>/<span class="number">24</span> brd <span class="number">192.168</span>.<span class="number">83.255</span> scope <span class="keyword">global</span> eth0</span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">    <span class="keyword">inet6</span> fe80::<span class="number">5054</span>:<span class="number">83</span>ff:fecc:dd00/<span class="number">64</span> scope link</span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line"><span class="number">3</span>: eth20: <span class="variable">&lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt;</span> mtu <span class="number">1500</span> qdisc pfifo_fast <span class="keyword">state</span> UP qlen <span class="number">1000</span></span><br><span class="line">    link/ether <span class="number">52</span>:<span class="number">54</span>:<span class="number">83</span>:cc:dd:<span class="number">20</span> brd ff:ff:ff:ff:ff:ff</span><br><span class="line">    <span class="keyword">inet</span> <span class="number">192.168</span>.<span class="number">84.85</span>/<span class="number">24</span> brd <span class="number">192.168</span>.<span class="number">84.255</span> scope <span class="keyword">global</span> eth20</span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">    <span class="keyword">inet6</span> fe80::<span class="number">5054</span>:<span class="number">83</span>ff:fecc:dd20/<span class="number">64</span> scope link</span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line"><span class="number">4</span>: eth21: <span class="variable">&lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt;</span> mtu <span class="number">1500</span> qdisc pfifo_fast <span class="keyword">state</span> UP qlen <span class="number">1000</span></span><br><span class="line">    link/ether <span class="number">52</span>:<span class="number">54</span>:<span class="number">83</span>:cc:dd:<span class="number">21</span> brd ff:ff:ff:ff:ff:ff</span><br><span class="line">    <span class="keyword">inet</span> <span class="number">192.168</span>.<span class="number">85.85</span>/<span class="number">24</span> brd <span class="number">192.168</span>.<span class="number">85.255</span> scope <span class="keyword">global</span> eth21</span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">    <span class="keyword">inet6</span> fe80::<span class="number">5054</span>:<span class="number">83</span>ff:fecc:dd21/<span class="number">64</span> scope link</span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line"><span class="number">5</span>: docker_gwbridge: <span class="variable">&lt;NO-CARRIER,BROADCAST,MULTICAST,UP&gt;</span> mtu <span class="number">1500</span> qdisc noqueue <span class="keyword">state</span> DOWN</span><br><span class="line">    link/ether <span class="number">02</span>:<span class="number">42</span>:<span class="number">4</span>f:bd:<span class="number">6</span>d:e3 brd ff:ff:ff:ff:ff:ff</span><br><span class="line">    <span class="keyword">inet</span> <span class="number">172.18</span>.<span class="number">0.1</span>/<span class="number">20</span> scope <span class="keyword">global</span> docker_gwbridge</span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line"><span class="number">8</span>: docker0: <span class="variable">&lt;NO-CARRIER,BROADCAST,MULTICAST,UP&gt;</span> mtu <span class="number">1500</span> qdisc noqueue <span class="keyword">state</span> DOWN</span><br><span class="line">    link/ether <span class="number">02</span>:<span class="number">42</span>:<span class="number">40</span>:<span class="number">2</span>d:<span class="number">14</span>:<span class="number">72</span> brd ff:ff:ff:ff:ff:ff</span><br><span class="line">    <span class="keyword">inet</span> <span class="number">10.76</span>.<span class="number">84.22</span>/<span class="number">24</span> scope <span class="keyword">global</span> docker0</span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">    <span class="keyword">inet6</span> fe80::<span class="number">42</span>:<span class="number">40</span>ff:fe2d:<span class="number">1472</span>/<span class="number">64</span> scope link</span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">[root@jamza_vm_lp0_litepaas master]<span class="comment">#</span></span><br><span class="line">[root@jamza_vm_lp0_litepaas master]<span class="comment"># ip route</span></span><br><span class="line"><span class="keyword">default</span> via <span class="number">192.168</span>.<span class="number">83.1</span> dev eth0</span><br><span class="line"><span class="number">10.76</span>.<span class="number">84.0</span>/<span class="number">24</span> dev docker0 <span class="keyword">proto</span> kernel scope link src <span class="number">10.76</span>.<span class="number">84.22</span></span><br><span class="line"><span class="number">169.254</span>.<span class="number">0.0</span>/<span class="number">16</span> dev eth0 scope link metric <span class="number">1002</span></span><br><span class="line"><span class="number">169.254</span>.<span class="number">0.0</span>/<span class="number">16</span> dev eth20 scope link metric <span class="number">1003</span></span><br><span class="line"><span class="number">169.254</span>.<span class="number">0.0</span>/<span class="number">16</span> dev eth21 scope link metric <span class="number">1004</span></span><br><span class="line"><span class="number">172.18</span>.<span class="number">0.0</span>/<span class="number">20</span> dev docker_gwbridge <span class="keyword">proto</span> kernel scope link src <span class="number">172.18</span>.<span class="number">0.1</span></span><br><span class="line"><span class="number">192.168</span>.<span class="number">83.0</span>/<span class="number">24</span> dev eth0 <span class="keyword">proto</span> kernel scope link src <span class="number">192.168</span>.<span class="number">83.85</span></span><br><span class="line"><span class="number">192.168</span>.<span class="number">84.0</span>/<span class="number">24</span> dev eth20 <span class="keyword">proto</span> kernel scope link src <span class="number">192.168</span>.<span class="number">84.85</span></span><br><span class="line"><span class="number">192.168</span>.<span class="number">85.0</span>/<span class="number">24</span> dev eth21 <span class="keyword">proto</span> kernel scope link src <span class="number">192.168</span>.<span class="number">85.85</span></span><br><span class="line">[root@jamza_vm_lp0_litepaas master]<span class="comment">#</span></span><br></pre></td></tr></table></figure>

<p>在主控上创建一个网桥，为网桥分配 ip 地址，并将自定义的网桥桥接本地的网卡 eth20：</p>
<figure class="highlight autoit"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">[root<span class="symbol">@jamza_vm_lp0_litepaas</span> master]<span class="meta">#</span></span><br><span class="line">[root<span class="symbol">@jamza_vm_lp0_litepaas</span> master]<span class="meta"># brctl addbr br1</span></span><br><span class="line">[root<span class="symbol">@jamza_vm_lp0_litepaas</span> master]<span class="meta">#</span></span><br><span class="line">[root<span class="symbol">@jamza_vm_lp0_litepaas</span> master]<span class="meta">#</span></span><br><span class="line">[root<span class="symbol">@jamza_vm_lp0_litepaas</span> master]<span class="meta"># ifconfig br1 192.168.84.1 netmask 255.255.255.0</span></span><br><span class="line">[root<span class="symbol">@jamza_vm_lp0_litepaas</span> master]<span class="meta">#</span></span><br><span class="line">[root<span class="symbol">@jamza_vm_lp0_litepaas</span> master]<span class="meta"># brctl addif br1 eth20</span></span><br><span class="line">[root<span class="symbol">@jamza_vm_lp0_litepaas</span> master]<span class="meta">#</span></span><br></pre></td></tr></table></figure>

<p>修改 docker 的服务端配置，使得 docker 默认连接自定义的网桥 br1，而不是默认的 docker0 网桥，并配置线卡上的容器 ip 地址池为 192.168.84.240/28，以防止线卡上的容器 ip 地址与主控上的容器 ip 地址冲突，注意，设置默认网桥与地址池的字段分别是 bridge 与 fixed-cidr，然后重启 docker 服务端：</p>
<figure class="highlight autoit"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">[root<span class="symbol">@jamza_vm_lp0_litepaas</span> master]<span class="meta"># vi /etc/docker/daemon.json</span></span><br><span class="line">[root<span class="symbol">@jamza_vm_lp0_litepaas</span> master]<span class="meta">#</span></span><br><span class="line">[root<span class="symbol">@jamza_vm_lp0_litepaas</span> master]<span class="meta"># cat /etc/docker/daemon.json</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="string">&quot;bridge&quot;</span>:<span class="string">&quot;br1&quot;</span>,</span><br><span class="line"><span class="string">&quot;fixed-cidr&quot;</span>:<span class="string">&quot;192.168.84.240/28&quot;</span>,</span><br><span class="line"><span class="string">&quot;cpu-rt-runtime&quot;</span>:<span class="number">800000</span>,</span><br><span class="line"><span class="string">&quot;cpu-rt-period&quot;</span>:<span class="number">1000000</span>,</span><br><span class="line"><span class="string">&quot;storage-driver&quot;</span>:<span class="string">&quot;overlay2&quot;</span>,</span><br><span class="line"><span class="string">&quot;storage-opts&quot;</span>:[<span class="string">&quot;overlay2.override_kernel_check=true&quot;</span>]</span><br><span class="line">&#125;</span><br><span class="line">&#123; <span class="string">&quot;insecure-registries&quot;</span>:[<span class="string">&quot;192.168.83.241:5000&quot;</span>]&#125;</span><br><span class="line">[root<span class="symbol">@jamza_vm_lp0_litepaas</span> master]<span class="meta">#</span></span><br><span class="line">[root<span class="symbol">@jamza_vm_lp0_litepaas</span> master]<span class="meta"># systemctl daemon-reload</span></span><br><span class="line">[root<span class="symbol">@jamza_vm_lp0_litepaas</span> master]<span class="meta">#</span></span><br><span class="line">[root<span class="symbol">@jamza_vm_lp0_litepaas</span> master]<span class="meta"># service docker restart</span></span><br><span class="line">Redirecting <span class="keyword">to</span> /bin/systemctl restart docker.service</span><br><span class="line">[root<span class="symbol">@jamza_vm_lp0_litepaas</span> master]<span class="meta">#</span></span><br></pre></td></tr></table></figure>

<p>此时查看线卡上的 ip 地址，出现 br1 网桥：</p>
<figure class="highlight pf"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line">[root@jamza_vm_lp0_litepaas master]<span class="comment"># ip addr</span></span><br><span class="line"><span class="number">1</span>: lo: <span class="variable">&lt;LOOPBACK,UP,LOWER_UP&gt;</span> mtu <span class="number">65536</span> qdisc noqueue <span class="keyword">state</span> UNKNOWN qlen <span class="number">1</span></span><br><span class="line">    link/loopback <span class="number">00</span>:<span class="number">00</span>:<span class="number">00</span>:<span class="number">00</span>:<span class="number">00</span>:<span class="number">00</span> brd <span class="number">00</span>:<span class="number">00</span>:<span class="number">00</span>:<span class="number">00</span>:<span class="number">00</span>:<span class="number">00</span></span><br><span class="line">    <span class="keyword">inet</span> <span class="number">127.0</span>.<span class="number">0.1</span>/<span class="number">8</span> scope host lo</span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">    <span class="keyword">inet6</span> ::<span class="number">1</span>/<span class="number">128</span> scope host</span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line"><span class="number">2</span>: eth0: <span class="variable">&lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt;</span> mtu <span class="number">1500</span> qdisc pfifo_fast <span class="keyword">state</span> UP qlen <span class="number">1000</span></span><br><span class="line">    link/ether <span class="number">52</span>:<span class="number">54</span>:<span class="number">83</span>:cc:dd:<span class="number">00</span> brd ff:ff:ff:ff:ff:ff</span><br><span class="line">    <span class="keyword">inet</span> <span class="number">192.168</span>.<span class="number">83.85</span>/<span class="number">24</span> brd <span class="number">192.168</span>.<span class="number">83.255</span> scope <span class="keyword">global</span> eth0</span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">    <span class="keyword">inet6</span> fe80::<span class="number">5054</span>:<span class="number">83</span>ff:fecc:dd00/<span class="number">64</span> scope link</span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line"><span class="number">3</span>: eth20: <span class="variable">&lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt;</span> mtu <span class="number">1500</span> qdisc pfifo_fast master br1 <span class="keyword">state</span> UP qlen <span class="number">1000</span></span><br><span class="line">    link/ether <span class="number">52</span>:<span class="number">54</span>:<span class="number">83</span>:cc:dd:<span class="number">20</span> brd ff:ff:ff:ff:ff:ff</span><br><span class="line">    <span class="keyword">inet</span> <span class="number">192.168</span>.<span class="number">84.85</span>/<span class="number">24</span> brd <span class="number">192.168</span>.<span class="number">84.255</span> scope <span class="keyword">global</span> eth20</span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">    <span class="keyword">inet6</span> fe80::<span class="number">5054</span>:<span class="number">83</span>ff:fecc:dd20/<span class="number">64</span> scope link</span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line"><span class="number">4</span>: eth21: <span class="variable">&lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt;</span> mtu <span class="number">1500</span> qdisc pfifo_fast <span class="keyword">state</span> UP qlen <span class="number">1000</span></span><br><span class="line">    link/ether <span class="number">52</span>:<span class="number">54</span>:<span class="number">83</span>:cc:dd:<span class="number">21</span> brd ff:ff:ff:ff:ff:ff</span><br><span class="line">    <span class="keyword">inet</span> <span class="number">192.168</span>.<span class="number">85.85</span>/<span class="number">24</span> brd <span class="number">192.168</span>.<span class="number">85.255</span> scope <span class="keyword">global</span> eth21</span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">    <span class="keyword">inet6</span> fe80::<span class="number">5054</span>:<span class="number">83</span>ff:fecc:dd21/<span class="number">64</span> scope link</span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line"><span class="number">5</span>: docker_gwbridge: <span class="variable">&lt;NO-CARRIER,BROADCAST,MULTICAST,UP&gt;</span> mtu <span class="number">1500</span> qdisc noqueue <span class="keyword">state</span> DOWN</span><br><span class="line">    link/ether <span class="number">02</span>:<span class="number">42</span>:<span class="number">4</span>f:bd:<span class="number">6</span>d:e3 brd ff:ff:ff:ff:ff:ff</span><br><span class="line">    <span class="keyword">inet</span> <span class="number">172.18</span>.<span class="number">0.1</span>/<span class="number">20</span> scope <span class="keyword">global</span> docker_gwbridge</span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line"><span class="number">8</span>: docker0: <span class="variable">&lt;NO-CARRIER,BROADCAST,MULTICAST,UP&gt;</span> mtu <span class="number">1500</span> qdisc noqueue <span class="keyword">state</span> DOWN</span><br><span class="line">    link/ether <span class="number">02</span>:<span class="number">42</span>:<span class="number">40</span>:<span class="number">2</span>d:<span class="number">14</span>:<span class="number">72</span> brd ff:ff:ff:ff:ff:ff</span><br><span class="line">    <span class="keyword">inet</span> <span class="number">10.76</span>.<span class="number">84.22</span>/<span class="number">24</span> scope <span class="keyword">global</span> docker0</span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">    <span class="keyword">inet6</span> fe80::<span class="number">42</span>:<span class="number">40</span>ff:fe2d:<span class="number">1472</span>/<span class="number">64</span> scope link</span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line"><span class="number">118</span>: br1: <span class="variable">&lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt;</span> mtu <span class="number">1500</span> qdisc noqueue <span class="keyword">state</span> UP qlen <span class="number">1000</span></span><br><span class="line">    link/ether <span class="number">52</span>:<span class="number">54</span>:<span class="number">83</span>:cc:dd:<span class="number">20</span> brd ff:ff:ff:ff:ff:ff</span><br><span class="line">    <span class="keyword">inet</span> <span class="number">192.168</span>.<span class="number">84.1</span>/<span class="number">24</span> brd <span class="number">192.168</span>.<span class="number">84.255</span> scope <span class="keyword">global</span> br1</span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">    <span class="keyword">inet6</span> fe80::<span class="number">10</span>c6:b7ff:fe09:ff42/<span class="number">64</span> scope link</span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">[root@jamza_vm_lp0_litepaas master]<span class="comment">#</span></span><br></pre></td></tr></table></figure>

<p>查看线卡上的 ip 路由信息，注意这里出现了两个 192.168.84.0/24 网段的路由路径：</p>
<figure class="highlight accesslog"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">[root@jamza_vm_lp0_litepaas master]</span># ip route</span><br><span class="line">default via <span class="number">192</span>.<span class="number">168</span>.<span class="number">83</span>.<span class="number">1</span> dev eth0</span><br><span class="line"><span class="number">10.76.84.0</span>/<span class="number">24</span> dev docker0 proto kernel scope link src <span class="number">10</span>.<span class="number">76</span>.<span class="number">84</span>.<span class="number">22</span></span><br><span class="line"><span class="number">169.254.0.0</span>/<span class="number">16</span> dev eth0 scope link metric <span class="number">1002</span></span><br><span class="line"><span class="number">169.254.0.0</span>/<span class="number">16</span> dev eth20 scope link metric <span class="number">1003</span></span><br><span class="line"><span class="number">169.254.0.0</span>/<span class="number">16</span> dev eth21 scope link metric <span class="number">1004</span></span><br><span class="line"><span class="number">172.18.0.0</span>/<span class="number">20</span> dev docker_gwbridge proto kernel scope link src <span class="number">172</span>.<span class="number">18</span>.<span class="number">0</span>.<span class="number">1</span></span><br><span class="line"><span class="number">192.168.83.0</span>/<span class="number">24</span> dev eth0 proto kernel scope link src <span class="number">192</span>.<span class="number">168</span>.<span class="number">83</span>.<span class="number">85</span></span><br><span class="line"><span class="number">192.168.84.0</span>/<span class="number">24</span> dev eth20 proto kernel scope link src <span class="number">192</span>.<span class="number">168</span>.<span class="number">84</span>.<span class="number">85</span></span><br><span class="line"><span class="number">192.168.84.0</span>/<span class="number">24</span> dev br1 proto kernel scope link src <span class="number">192</span>.<span class="number">168</span>.<span class="number">84</span>.<span class="number">1</span></span><br><span class="line"><span class="number">192.168.85.0</span>/<span class="number">24</span> dev eth21 proto kernel scope link src <span class="number">192</span>.<span class="number">168</span>.<span class="number">85</span>.<span class="number">85</span></span><br><span class="line"><span class="string">[root@jamza_vm_lp0_litepaas master]</span>#</span><br></pre></td></tr></table></figure>

<h2 id="容器互通测试"><a href="#容器互通测试" class="headerlink" title="容器互通测试"></a>容器互通测试</h2><p>在主控上创建容器，网络使用默认 bridge 模式，根据之前的设定，容器将连接到自定义网桥 br1 上，且从分配的地址池中取出可用的 ip 地址：</p>
<figure class="highlight vim"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">[root@jamza_vm_master_litepaas master]# docker run -it --privileged=true --name test busybox/x86_64 /bin/<span class="keyword">sh</span></span><br><span class="line">/ #</span><br><span class="line">/ # ifconfig</span><br><span class="line">eth0      Link encap:Ethernet  HWaddr <span class="number">02</span>:<span class="number">42</span>:C0:A8:<span class="number">54</span>:E0</span><br><span class="line">          inet addr:<span class="number">192.168</span>.<span class="number">84.224</span>  Bcas<span class="variable">t:0</span>.<span class="number">0.0</span>.<span class="number">0</span>  Mask:<span class="number">255.255</span>.<span class="number">255.0</span></span><br><span class="line">          inet6 addr: fe80::<span class="number">42</span>:c0ff:fea8:<span class="number">54</span>e0/<span class="number">64</span> Scope:Link</span><br><span class="line">          UP BROADCAST RUNNING MULTICAST  MTU:<span class="number">1500</span>  Metric:<span class="number">1</span></span><br><span class="line">          RX packet<span class="variable">s:12</span> error<span class="variable">s:0</span> dropped:<span class="number">4</span> overrun<span class="variable">s:0</span> frame:<span class="number">0</span></span><br><span class="line">          TX packet<span class="variable">s:6</span> error<span class="variable">s:0</span> dropped:<span class="number">0</span> overrun<span class="variable">s:0</span> carrier:<span class="number">0</span></span><br><span class="line">          collision<span class="variable">s:0</span> txqueuelen:<span class="number">0</span></span><br><span class="line">          RX byte<span class="variable">s:908</span> (<span class="number">908.0</span> B)  TX byte<span class="variable">s:508</span> (<span class="number">508.0</span> B)</span><br><span class="line"></span><br><span class="line"><span class="keyword">lo</span>        Link encap:Local Loopback</span><br><span class="line">          inet addr:<span class="number">127.0</span>.<span class="number">0.1</span>  Mask:<span class="number">255.0</span>.<span class="number">0.0</span></span><br><span class="line">          inet6 addr: ::<span class="number">1</span>/<span class="number">128</span> Scope:Host</span><br><span class="line">          UP LOOPBACK RUNNING  MTU:<span class="number">65536</span>  Metric:<span class="number">1</span></span><br><span class="line">          RX packet<span class="variable">s:0</span> error<span class="variable">s:0</span> dropped:<span class="number">0</span> overrun<span class="variable">s:0</span> frame:<span class="number">0</span></span><br><span class="line">          TX packet<span class="variable">s:0</span> error<span class="variable">s:0</span> dropped:<span class="number">0</span> overrun<span class="variable">s:0</span> carrier:<span class="number">0</span></span><br><span class="line">          collision<span class="variable">s:0</span> txqueuelen:<span class="number">1</span></span><br><span class="line">          RX byte<span class="variable">s:0</span> (<span class="number">0.0</span> B)  TX byte<span class="variable">s:0</span> (<span class="number">0.0</span> B)</span><br><span class="line"></span><br><span class="line">/ #</span><br></pre></td></tr></table></figure>

<p>在线卡上创建容器，网络使用默认 bridge 模式，根据之前的设定，容器将连接到自定义网桥 br1 上，且从分配的地址池中取出可用的 ip 地址：</p>
<figure class="highlight vim"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">[root@jamza_vm_lp0_litepaas master]# docker run -it --privileged=true --name test busybox/x86_64 /bin/<span class="keyword">sh</span></span><br><span class="line">/ #</span><br><span class="line">/ # ifconfig</span><br><span class="line">eth0      Link encap:Ethernet  HWaddr <span class="number">02</span>:<span class="number">42</span>:C0:A8:<span class="number">54</span>:F0</span><br><span class="line">          inet addr:<span class="number">192.168</span>.<span class="number">84.240</span>  Bcas<span class="variable">t:0</span>.<span class="number">0.0</span>.<span class="number">0</span>  Mask:<span class="number">255.255</span>.<span class="number">255.0</span></span><br><span class="line">          inet6 addr: fe80::<span class="number">42</span>:c0ff:fea8:<span class="number">54</span>f0/<span class="number">64</span> Scope:Link</span><br><span class="line">          UP BROADCAST RUNNING MULTICAST  MTU:<span class="number">1500</span>  Metric:<span class="number">1</span></span><br><span class="line">          RX packet<span class="variable">s:10</span> error<span class="variable">s:0</span> dropped:<span class="number">3</span> overrun<span class="variable">s:0</span> frame:<span class="number">0</span></span><br><span class="line">          TX packet<span class="variable">s:6</span> error<span class="variable">s:0</span> dropped:<span class="number">0</span> overrun<span class="variable">s:0</span> carrier:<span class="number">0</span></span><br><span class="line">          collision<span class="variable">s:0</span> txqueuelen:<span class="number">0</span></span><br><span class="line">          RX byte<span class="variable">s:782</span> (<span class="number">782.0</span> B)  TX byte<span class="variable">s:508</span> (<span class="number">508.0</span> B)</span><br><span class="line"></span><br><span class="line"><span class="keyword">lo</span>        Link encap:Local Loopback</span><br><span class="line">          inet addr:<span class="number">127.0</span>.<span class="number">0.1</span>  Mask:<span class="number">255.0</span>.<span class="number">0.0</span></span><br><span class="line">          inet6 addr: ::<span class="number">1</span>/<span class="number">128</span> Scope:Host</span><br><span class="line">          UP LOOPBACK RUNNING  MTU:<span class="number">65536</span>  Metric:<span class="number">1</span></span><br><span class="line">          RX packet<span class="variable">s:0</span> error<span class="variable">s:0</span> dropped:<span class="number">0</span> overrun<span class="variable">s:0</span> frame:<span class="number">0</span></span><br><span class="line">          TX packet<span class="variable">s:0</span> error<span class="variable">s:0</span> dropped:<span class="number">0</span> overrun<span class="variable">s:0</span> carrier:<span class="number">0</span></span><br><span class="line">          collision<span class="variable">s:0</span> txqueuelen:<span class="number">1</span></span><br><span class="line">          RX byte<span class="variable">s:0</span> (<span class="number">0.0</span> B)  TX byte<span class="variable">s:0</span> (<span class="number">0.0</span> B)</span><br><span class="line"></span><br><span class="line">/ #</span><br></pre></td></tr></table></figure>

<p>主控上的容器 ping 线卡上的容器，以及线卡上的容器 ping 主控上的容器，结果显示，均能够 ping 通。</p>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#主控上的容器ping线卡上的容器</span></span><br><span class="line">/ #</span><br><span class="line">/ #<span class="built_in"> ping </span>192.168.84.240<span class="built_in"></span></span><br><span class="line"><span class="built_in">PING </span>192.168.84.240 (192.168.84.240): 56 data bytes</span><br><span class="line">64 bytes <span class="keyword">from</span> 192.168.84.240: <span class="attribute">seq</span>=0 <span class="attribute">ttl</span>=64 <span class="attribute">time</span>=0.683 ms</span><br><span class="line">64 bytes <span class="keyword">from</span> 192.168.84.240: <span class="attribute">seq</span>=1 <span class="attribute">ttl</span>=64 <span class="attribute">time</span>=0.403 ms</span><br><span class="line">64 bytes <span class="keyword">from</span> 192.168.84.240: <span class="attribute">seq</span>=2 <span class="attribute">ttl</span>=64 <span class="attribute">time</span>=0.413 ms</span><br><span class="line">64 bytes <span class="keyword">from</span> 192.168.84.240: <span class="attribute">seq</span>=3 <span class="attribute">ttl</span>=64 <span class="attribute">time</span>=0.296 ms</span><br><span class="line">^C</span><br><span class="line">--- 192.168.84.240<span class="built_in"> ping </span>statistics ---</span><br><span class="line">4 packets transmitted, 4 packets received, 0% packet loss</span><br><span class="line">round-trip min/avg/max = 0.296/0.448/0.683 ms</span><br><span class="line">/ #</span><br><span class="line"></span><br><span class="line"><span class="comment">#线卡上的容器ping主控上的容器</span></span><br><span class="line">/ #<span class="built_in"> ping </span>192.168.84.224<span class="built_in"></span></span><br><span class="line"><span class="built_in">PING </span>192.168.84.224 (192.168.84.224): 56 data bytes</span><br><span class="line">64 bytes <span class="keyword">from</span> 192.168.84.224: <span class="attribute">seq</span>=0 <span class="attribute">ttl</span>=64 <span class="attribute">time</span>=0.393 ms</span><br><span class="line">64 bytes <span class="keyword">from</span> 192.168.84.224: <span class="attribute">seq</span>=1 <span class="attribute">ttl</span>=64 <span class="attribute">time</span>=0.421 ms</span><br><span class="line">64 bytes <span class="keyword">from</span> 192.168.84.224: <span class="attribute">seq</span>=2 <span class="attribute">ttl</span>=64 <span class="attribute">time</span>=0.542 ms</span><br><span class="line">64 bytes <span class="keyword">from</span> 192.168.84.224: <span class="attribute">seq</span>=3 <span class="attribute">ttl</span>=64 <span class="attribute">time</span>=0.414 ms</span><br><span class="line">^C</span><br><span class="line">--- 192.168.84.224<span class="built_in"> ping </span>statistics ---</span><br><span class="line">4 packets transmitted, 4 packets received, 0% packet loss</span><br><span class="line">round-trip min/avg/max = 0.393/0.442/0.542 ms</span><br><span class="line">/ #</span><br></pre></td></tr></table></figure>

<p>若想主机也能 ping 主机上容器内的，则需删除主机上的路由信息：</p>
<p>192.168.84.0/24 dev eth20 proto kernel scope link src 192.168.84.85</p>
<p>192.168.84.0/24 dev eth20 proto kernel scope link src 192.168.84.83</p>

        </div>

        
            <section class="post-copyright">
                
                
                
                

            </section>
        
        <section class="post-tags">
            <div>
                <span>Tag(s):</span>
                <span class="tag">
                    
                    
                        <a href="/tags/docker/"># docker</a>
                    
                        
                </span>
            </div>
            <div>
                <a href="javascript:window.history.back();">back</a>
                <span>· </span>
                <a href="/">home</a>
            </div>
        </section>
        <section class="post-nav">
            
                <a class="prev" rel="prev" href="/2021/05/22/%E8%87%AA%E5%AE%9A%E4%B9%89%E7%BD%91%E7%BB%9C%E5%AE%9E%E7%8E%B0%E8%B7%A8%E4%B8%BB%E6%9C%BADocker%E9%80%9A%E4%BF%A1/">自定义网络实现跨主机 Docker 通信</a>
            
            
            <a class="next" rel="next" href="/2021/05/22/Linux%E5%BA%95%E5%B1%82%E7%9A%84socket%E5%9C%B0%E5%9D%80/">Linux底层的socket地址</a>
            
        </section>


    </article>
</div>

        </div>
        <footer id="footer" class="footer">
    <div class="copyright">
        <span>© Jamza | Powered by <a href="https://hexo.io" target="_blank">Hexo</a> & <a href="https://github.com/Siricee/hexo-theme-Chic" target="_blank">Chic</a></span>
    </div>
</footer>

    </div>
</body>
</html>
